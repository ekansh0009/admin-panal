<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PAPI Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
    .logo-circle {
      width: 34px; height: 34px; border-radius: 999px;
      background: #4c6fff; display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px;
    }
    .sidebar-title { font-weight: 700; font-size: 18px; }
    .sidebar-sub { font-size: 11px; color: #9ca3af; }
    .nav { list-style: none; margin-top: 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link {
      width: 100%; border-radius: 10px; padding: 8px 10px;
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; font-size: 14px; color: #e5e7eb;
      border: none; background: transparent; text-align: left;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .nav-link span.icon { font-size: 16px; width: 18px; text-align: center; }
    .nav-link.active, .nav-link:hover { background: #111827; color: #ffffff; }
    .sidebar-footer { margin-top: auto; font-size: 12px; color: #6b7280; }

    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .topbar {
      height: 56px; background: #ffffff; border-bottom: 1px solid #e5e7eb;
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    }
    .topbar-title { font-weight: 600; font-size: 16px; }
    .topbar-right { display: flex; align-items: center; gap: 12px; font-size: 13px; color: #6b7280; }
    .avatar {
      width: 32px; height: 32px; border-radius: 999px; background: #4c6fff; color: #fff;
      display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600;
    }
    .logout-btn {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px;
      background: #ffffff; color: #374151; font-size: 12px; cursor: pointer;
    }

    .content { padding: 18px 20px 24px; min-height: calc(100vh - 56px); }
    .section { display: none; }
    .section.active { display: block; }
    .section-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; gap: 10px; flex-wrap: wrap;
    }
    .section-title { font-size: 20px; font-weight: 700; }
    .btn-primary {
      border-radius: 10px; border: none; padding: 8px 14px; background: #4c6fff; color: #ffffff;
      font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-secondary {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px; background: #ffffff;
      color: #374151; font-size: 12px; cursor: pointer;
    }

    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; margin-bottom: 18px; }
    .card { background: #ffffff; border-radius: 14px; padding: 14px; border: 1px solid #e5e7eb; }
    .card-title { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
    .card-value { font-size: 18px; font-weight: 700; }
    .card-sub { font-size: 11px; color: #9ca3af; margin-top: 4px; }

    .section-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
    .toolbar-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .toolbar-input {
      border-radius: 999px; border: 1px solid #e5e7eb; padding: 7px 10px;
      font-size: 13px; background: #ffffff; min-width: 160px;
    }
    .toolbar-input::placeholder { color: #9ca3af; }

    table {
      width: 100%; border-collapse: collapse; font-size: 13px; background: #ffffff;
      border-radius: 14px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    thead { background: #f9fafb; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { font-size: 12px; font-weight: 600; color: #6b7280; }
    tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: #f9fafb; }

    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .badge-free { background: #e0f2fe; color: #0369a1; }
    .badge-paid { background: #fef3c7; color: #b45309; }
    .badge-status { background: #ecfdf5; color: #15803d; }

    .muted { font-size: 12px; color: #9ca3af; margin-top: 8px; }

    .inline-form {
      margin-top: 14px; background: #ffffff; border-radius: 14px; border: 1px solid #e5e7eb;
      padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .inline-input { flex: 1 1 180px; min-width: 0; }
    .inline-input input, .inline-input select, .inline-input textarea {
      width: 100%; border-radius: 8px; border: 1px solid #e5e7eb; padding: 7px 9px; font-size: 13px; resize: vertical;
    }

    #overlay {
      position: fixed; inset: 0; background: rgba(243, 244, 246, 0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; font-size: 14px; color: #6b7280;
    }

    #courseContentEditor { margin-top: 16px; }
    .cc-editor-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .cc-editor-subtitle { font-size: 12px; color: #6b7280; }
    .cc-sections-container { display: flex; flex-direction: column; gap: 10px; margin-top: 4px; }
    .cc-section-card { border-radius: 12px; border: 1px solid #e5e7eb; padding: 10px 12px; background: #f9fafb; }
    .cc-section-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    .cc-section-title { font-size: 14px; font-weight: 600; }
    .cc-section-desc { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .cc-section-actions { display: flex; flex-wrap: wrap; gap: 6px; }
    .cc-lessons-wrapper { margin-top: 6px; }

    .cc-lessons-table {
      width: 100%; border-collapse: collapse; font-size: 12px; background: #ffffff;
      border-radius: 10px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    .cc-lessons-table th, .cc-lessons-table td { padding: 6px 8px; border-bottom: 1px solid #e5e7eb; }
    .cc-lessons-table th { background: #f3f4f6; font-weight: 600; color: #6b7280; }
    .cc-lessons-table tr:last-child td { border-bottom: none; }

    .cc-tag-lock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #fee2e2; color: #b91c1c;
    }
    .cc-tag-unlock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #dcfce7; color: #15803d;
    }

    .cc-json-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
    .cc-json-output {
      margin-top: 4px; width: 100%; min-height: 140px; max-height: 260px;
      border-radius: 10px; border: 1px solid #e5e7eb; padding: 8px 10px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #f9fafb; resize: vertical; white-space: pre; overflow: auto;
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      body { flex-direction: column; }
      .main { width: 100%; }
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .inline-form { flex-direction: column; align-items: stretch; }
      .section-toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-input { width: 100%; }
      .cc-section-header { flex-direction: column; align-items: flex-start; }
      .cc-section-actions { width: 100%; }
    }
  </style>
</head>

<body>
  <div id="overlay">Checking admin access‚Ä¶</div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle">P</div>
      <div>
        <div class="sidebar-title">PAPI Admin</div>
        <div class="sidebar-sub">Control panel</div>
      </div>
    </div>

    <ul class="nav">
      <li class="nav-item"><button class="nav-link active" data-section="overview"><span class="icon">üè†</span> Dashboard</button></li>
      <li class="nav-item"><button class="nav-link" data-section="courses"><span class="icon">üìö</span> Courses</button></li>
      <li class="nav-item"><button class="nav-link" data-section="tests"><span class="icon">üìù</span> Tests</button></li>
      <li class="nav-item"><button class="nav-link" data-section="updates"><span class="icon">üì¢</span> Updates</button></li>
      <li class="nav-item"><button class="nav-link" data-section="settings"><span class="icon">‚öôÔ∏è</span> Settings</button></li>
    </ul>

    <div class="sidebar-footer">
      ¬© PAPI ‚Ä¢ v0.3<br />
      (Connected to local backend)
    </div>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-title">PAPI Admin Panel</div>
      <div class="topbar-right">
        <span id="adminEmail">Admin</span>
        <div class="avatar" id="avatarInitial">A</div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </header>

    <main class="content">
      <section class="section active" id="section-overview">
        <div class="section-header"><h2 class="section-title">Overview</h2></div>
        <div class="grid">
          <div class="card"><div class="card-title">Total Courses</div><div class="card-value" id="stat-courses">0</div><div class="card-sub">Free + paid</div></div>
          <div class="card"><div class="card-title">Total Tests</div><div class="card-value" id="stat-tests">0</div><div class="card-sub">Active test series</div></div>
          <div class="card"><div class="card-title">Total Updates</div><div class="card-value" id="stat-updates">0</div><div class="card-sub">Announcements</div></div>
        </div>
        <p class="muted">Now stats are coming from backend DB (SQLite). Refresh will keep the data.</p>
      </section>

      <!-- COURSES -->
      <section class="section" id="section-courses">
        <div class="section-header">
          <h2 class="section-title">Courses</h2>
          <button class="btn-primary" id="addCourseScrollBtn">+ Add new course</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="courseSearch" class="toolbar-input" placeholder="Search courses..." />
            <select id="courseFilterType" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
        </div>

        <table id="coursesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Level</th>
              <th>Type</th>
              <th>Price</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="courseForm">
          <div class="inline-input"><input type="text" id="courseTitle" placeholder="Course title" required /></div>
          <div class="inline-input"><input type="text" id="courseLevel" placeholder="Level (e.g. Class 11 / JEE)" /></div>
          <div class="inline-input">
            <select id="courseType">
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="inline-input"><input type="number" id="coursePrice" placeholder="Price (‚Çπ)" min="0" /></div>
          <div class="inline-input"><input type="text" id="courseSubtitle" placeholder="Subtitle (short tagline)" /></div>
          <button type="submit" class="btn-primary" id="courseSubmitBtn">Save course</button>
          <button type="button" class="btn-secondary" id="courseCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Course Content Editor (local only for now) -->
        <div class="card" id="courseContentEditor" style="display:none;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Course content</div>
              <div class="cc-editor-subtitle">Manage sections & lessons for: <strong id="ccCourseTitle"></strong></div>
            </div>
            <button class="btn-primary" id="ccAddSectionBtn">+ Add section</button>
          </div>

          <div class="cc-json-toolbar">
            <button class="btn-secondary" id="ccShowJsonBtn">Show JSON</button>
            <button class="btn-secondary" id="ccCopyJsonBtn">Copy JSON</button>
          </div>
          <textarea id="ccJsonOutput" class="cc-json-output" readonly style="display:none;"></textarea>

          <div class="cc-sections-container" id="ccSectionsContainer"></div>
          <p class="muted">
            Note: content editor is local for now. Backend endpoints will be added later to save this JSON.
          </p>
        </div>

        <p class="muted">Courses are now saved in SQLite via API.</p>
      </section>

      <!-- TESTS -->
      <section class="section" id="section-tests">
        <div class="section-header">
          <h2 class="section-title">Tests</h2>
          <button class="btn-primary" id="addTestScrollBtn">+ Add new test</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="testSearch" class="toolbar-input" placeholder="Search tests..." />
            <select id="testFilterStatus" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
        </div>

        <table id="testsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Test Name</th>
              <th>Course</th>
              <th>Questions</th>
              <th>Duration</th>
              <th>Status</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="testForm">
          <div class="inline-input"><input type="text" id="testName" placeholder="Test title" required /></div>
          <div class="inline-input"><input type="text" id="testCourse" placeholder="Belongs to course" /></div>
          <div class="inline-input"><input type="number" id="testQuestions" placeholder="Questions" min="1" /></div>
          <div class="inline-input"><input type="text" id="testDuration" placeholder="Duration (e.g. 60 min)" /></div>
          <div class="inline-input">
            <select id="testStatus">
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <button type="submit" class="btn-primary" id="testSubmitBtn">Save test</button>
          <button type="button" class="btn-secondary" id="testCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Test content editor (local only) -->
        <div class="card" id="testContentEditor" style="display:none; margin-top:16px;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Test content</div>
              <div class="cc-editor-subtitle">Manage questions for: <strong id="tcTestTitle"></strong></div>
            </div>
            <button class="btn-primary" id="tcAddQuestionBtn">+ Add question</button>
          </div>
          <div class="cc-sections-container" id="tcQuestionsContainer"></div>
          <p class="muted">Note: questions editor is local for now. Backend endpoints will be added later.</p>
        </div>

        <p class="muted">Tests are now saved in SQLite via API.</p>
      </section>

      <!-- UPDATES -->
      <section class="section" id="section-updates">
        <div class="section-header">
          <h2 class="section-title">Updates</h2>
          <button class="btn-primary" id="addUpdateScrollBtn">+ Add new update</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="updateSearch" class="toolbar-input" placeholder="Search updates..." />
          </div>
        </div>

        <table id="updatesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Visible to</th>
              <th>Created at</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="updateForm">
          <div class="inline-input"><input type="text" id="updateTitle" placeholder="Update title" required /></div>
          <div class="inline-input"><input type="text" id="updateAudience" placeholder="Visible to (e.g. All / JEE / NEET)" /></div>
          <div class="inline-input"><textarea id="updateBody" rows="2" placeholder="Short description"></textarea></div>
          <button type="submit" class="btn-primary" id="updateSubmitBtn">Save update</button>
          <button type="button" class="btn-secondary" id="updateCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <p class="muted">Updates are now saved in SQLite via API.</p>
      </section>

      <section class="section" id="section-settings">
        <div class="section-header"><h2 class="section-title">Settings</h2></div>
        <div class="card">
          <div class="card-title">Admin Settings (placeholder)</div>
          <p class="muted">Future: admin users, app config, ads config, etc.</p>
        </div>
      </section>
    </main>
  </div>

 <script>
const API_BASE = "http://localhost:8080/api";

/* ========= FIREBASE ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBnDo5VJiM2noDWRWk281aVaUfPZ-sX08A",
  authDomain: "papi0009.firebaseapp.com",
  projectId: "papi0009",
  storageBucket: "papi0009.firebasestorage.app",
  messagingSenderId: "598318485319",
  appId: "1:598318485319:web:b26e84907d49a92d42c662",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const ALLOWED_ADMINS = ["admin@papi.in"];

const overlay = document.getElementById("overlay");
const logoutBtn = document.getElementById("logoutBtn");

auth.onAuthStateChanged((user) => {
  if (!user || !ALLOWED_ADMINS.includes(user.email)) {
    if (user) auth.signOut();
    window.location.href = "index.html";
  } else {
    overlay.style.display = "none";
    bootstrapLoad();
  }
});

logoutBtn.onclick = async () => {
  await auth.signOut();
  window.location.href = "index.html";
};

/* ========= GLOBAL STATE ========= */
let courses = [];
let tests = [];
let updates = [];
let currentContentCourseId = null;
let currentContentTestId = null;

/* ========= FETCH ========= */
async function fetchCourses() {
  const res = await fetch(`${API_BASE}/courses`);
  courses = await res.json();
}

async function fetchTests() {
  const res = await fetch(`${API_BASE}/tests`);
  tests = await res.json();
}

async function fetchUpdates() {
  const res = await fetch(`${API_BASE}/updates`);
  updates = await res.json();
}

/* ========= COURSE CONTENT BACKEND ========= */
async function openCourseContentEditor(courseId) {
  const res = await fetch(`${API_BASE}/courses/${courseId}/content`);
  const data = await res.json();
  currentContentCourseId = courseId;
  alert("Loaded content from DB ‚úÖ");
  console.log("Course content:", data);
}

async function saveCourseContent(payload) {
  if (!currentContentCourseId) return;
  await fetch(`${API_BASE}/courses/${currentContentCourseId}/content`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  alert("Course content saved to DB ‚úÖ");
}

/* ========= TEST QUESTIONS BACKEND ========= */
async function openTestContentEditor(testId) {
  const res = await fetch(`${API_BASE}/tests/${testId}/questions`);
  const data = await res.json();
  currentContentTestId = testId;
  alert("Loaded test questions from DB ‚úÖ");
  console.log("Test questions:", data);
}

async function saveTestQuestions(payload) {
  if (!currentContentTestId) return;
  await fetch(`${API_BASE}/tests/${currentContentTestId}/questions`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  alert("Test questions saved to DB ‚úÖ");
}

/* ========= COURSES CRUD ========= */
async function renderCourses() {
  await fetchCourses();
  const tbody = document.querySelector("#coursesTable tbody");
  tbody.innerHTML = "";

  courses.forEach((c, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${c.title}</td>
      <td>${c.level || "-"}</td>
      <td>${c.type}</td>
      <td>‚Çπ${c.price || 0}</td>
      <td>
        <button onclick="openCourseContentEditor(${c.id})">Content</button>
        <button onclick="deleteCourse(${c.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function deleteCourse(id) {
  await fetch(`${API_BASE}/courses/${id}`, { method: "DELETE" });
  renderCourses();
}

/* ========= TESTS CRUD ========= */
async function renderTests() {
  await fetchTests();
  const tbody = document.querySelector("#testsTable tbody");
  tbody.innerHTML = "";

  tests.forEach((t, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${t.name}</td>
      <td>${t.course || "-"}</td>
      <td>${t.questions || "-"}</td>
      <td>${t.duration || "-"}</td>
      <td>${t.status}</td>
      <td>
        <button onclick="openTestContentEditor(${t.id})">Content</button>
        <button onclick="deleteTest(${t.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function deleteTest(id) {
  await fetch(`${API_BASE}/tests/${id}`, { method: "DELETE" });
  renderTests();
}

/* ========= UPDATES ========= */
async function renderUpdates() {
  await fetchUpdates();
  const tbody = document.querySelector("#updatesTable tbody");
  tbody.innerHTML = "";

  updates.forEach((u, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${u.title}</td>
      <td>${u.audience || "All"}</td>
      <td>${u.created_at || "-"}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ========= BOOTSTRAP ========= */
async function bootstrapLoad() {
  await renderCourses();
  await renderTests();
  await renderUpdates();
}
</script>

</body>
</html>
