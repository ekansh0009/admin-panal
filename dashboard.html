<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PAPI Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
    .logo-circle {
      width: 34px; height: 34px; border-radius: 999px;
      background: #4c6fff; display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px;
    }
    .sidebar-title { font-weight: 700; font-size: 18px; }
    .sidebar-sub { font-size: 11px; color: #9ca3af; }
    .nav { list-style: none; margin-top: 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link {
      width: 100%; border-radius: 10px; padding: 8px 10px;
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; font-size: 14px; color: #e5e7eb;
      border: none; background: transparent; text-align: left;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .nav-link span.icon { font-size: 16px; width: 18px; text-align: center; }
    .nav-link.active, .nav-link:hover { background: #111827; color: #ffffff; }
    .sidebar-footer { margin-top: auto; font-size: 12px; color: #6b7280; }

    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .topbar {
      height: 56px; background: #ffffff; border-bottom: 1px solid #e5e7eb;
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    }
    .topbar-title { font-weight: 600; font-size: 16px; }
    .topbar-right { display: flex; align-items: center; gap: 12px; font-size: 13px; color: #6b7280; }
    .avatar {
      width: 32px; height: 32px; border-radius: 999px; background: #4c6fff; color: #fff;
      display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600;
    }
    .logout-btn {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px;
      background: #ffffff; color: #374151; font-size: 12px; cursor: pointer;
    }

    .content { padding: 18px 20px 24px; min-height: calc(100vh - 56px); }
    .section { display: none; }
    .section.active { display: block; }
    .section-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; gap: 10px; flex-wrap: wrap;
    }
    .section-title { font-size: 20px; font-weight: 700; }
    .btn-primary {
      border-radius: 10px; border: none; padding: 8px 14px; background: #4c6fff; color: #ffffff;
      font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-secondary {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px; background: #ffffff;
      color: #374151; font-size: 12px; cursor: pointer;
    }

    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; margin-bottom: 18px; }
    .card { background: #ffffff; border-radius: 14px; padding: 14px; border: 1px solid #e5e7eb; }
    .card-title { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
    .card-value { font-size: 18px; font-weight: 700; }
    .card-sub { font-size: 11px; color: #9ca3af; margin-top: 4px; }

    .section-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
    .toolbar-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .toolbar-input {
      border-radius: 999px; border: 1px solid #e5e7eb; padding: 7px 10px;
      font-size: 13px; background: #ffffff; min-width: 160px;
    }
    .toolbar-input::placeholder { color: #9ca3af; }

    table {
      width: 100%; border-collapse: collapse; font-size: 13px; background: #ffffff;
      border-radius: 14px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    thead { background: #f9fafb; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { font-size: 12px; font-weight: 600; color: #6b7280; }
    tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: #f9fafb; }

    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .badge-free { background: #e0f2fe; color: #0369a1; }
    .badge-paid { background: #fef3c7; color: #b45309; }
    .badge-status { background: #ecfdf5; color: #15803d; }

    .muted { font-size: 12px; color: #9ca3af; margin-top: 8px; }

    .inline-form {
      margin-top: 14px; background: #ffffff; border-radius: 14px; border: 1px solid #e5e7eb;
      padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .inline-input { flex: 1 1 180px; min-width: 0; }
    .inline-input input, .inline-input select, .inline-input textarea {
      width: 100%; border-radius: 8px; border: 1px solid #e5e7eb; padding: 7px 9px; font-size: 13px; resize: vertical;
    }

    #overlay {
      position: fixed; inset: 0; background: rgba(243, 244, 246, 0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; font-size: 14px; color: #6b7280;
    }

    #courseContentEditor { margin-top: 16px; }
    .cc-editor-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .cc-editor-subtitle { font-size: 12px; color: #6b7280; }
    .cc-sections-container { display: flex; flex-direction: column; gap: 10px; margin-top: 4px; }
    .cc-section-card { border-radius: 12px; border: 1px solid #e5e7eb; padding: 10px 12px; background: #f9fafb; }
    .cc-section-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    .cc-section-title { font-size: 14px; font-weight: 600; }
    .cc-section-desc { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .cc-section-actions { display: flex; flex-wrap: wrap; gap: 6px; }
    .cc-lessons-wrapper { margin-top: 6px; }

    .cc-lessons-table {
      width: 100%; border-collapse: collapse; font-size: 12px; background: #ffffff;
      border-radius: 10px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    .cc-lessons-table th, .cc-lessons-table td { padding: 6px 8px; border-bottom: 1px solid #e5e7eb; }
    .cc-lessons-table th { background: #f3f4f6; font-weight: 600; color: #6b7280; }
    .cc-lessons-table tr:last-child td { border-bottom: none; }

    .cc-tag-lock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #fee2e2; color: #b91c1c;
    }
    .cc-tag-unlock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #dcfce7; color: #15803d;
    }

    .cc-json-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
    .cc-json-output {
      margin-top: 4px; width: 100%; min-height: 140px; max-height: 260px;
      border-radius: 10px; border: 1px solid #e5e7eb; padding: 8px 10px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #f9fafb; resize: vertical; white-space: pre; overflow: auto;
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      body { flex-direction: column; }
      .main { width: 100%; }
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .inline-form { flex-direction: column; align-items: stretch; }
      .section-toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-input { width: 100%; }
      .cc-section-header { flex-direction: column; align-items: flex-start; }
      .cc-section-actions { width: 100%; }
    }
  </style>
</head>

<body>
  <div id="overlay">Checking admin access‚Ä¶</div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle">P</div>
      <div>
        <div class="sidebar-title">PAPI Admin</div>
        <div class="sidebar-sub">Control panel</div>
      </div>
    </div>

    <ul class="nav">
      <li class="nav-item"><button class="nav-link active" data-section="overview"><span class="icon">üè†</span> Dashboard</button></li>
      <li class="nav-item"><button class="nav-link" data-section="courses"><span class="icon">üìö</span> Courses</button></li>
      <li class="nav-item"><button class="nav-link" data-section="tests"><span class="icon">üìù</span> Tests</button></li>
      <li class="nav-item"><button class="nav-link" data-section="updates"><span class="icon">üì¢</span> Updates</button></li>
      <li class="nav-item"><button class="nav-link" data-section="settings"><span class="icon">‚öôÔ∏è</span> Settings</button></li>
    </ul>

    <div class="sidebar-footer">
      ¬© PAPI ‚Ä¢ v0.3<br />
      (Connected to local backend)
    </div>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-title">PAPI Admin Panel</div>
      <div class="topbar-right">
        <span id="adminEmail">Admin</span>
        <div class="avatar" id="avatarInitial">A</div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </header>

    <main class="content">
      <section class="section active" id="section-overview">
        <div class="section-header"><h2 class="section-title">Overview</h2></div>
        <div class="grid">
          <div class="card"><div class="card-title">Total Courses</div><div class="card-value" id="stat-courses">0</div><div class="card-sub">Free + paid</div></div>
          <div class="card"><div class="card-title">Total Tests</div><div class="card-value" id="stat-tests">0</div><div class="card-sub">Active test series</div></div>
          <div class="card"><div class="card-title">Total Updates</div><div class="card-value" id="stat-updates">0</div><div class="card-sub">Announcements</div></div>
        </div>
        <p class="muted">Now stats are coming from backend DB (SQLite). Refresh will keep the data.</p>
      </section>

      <!-- COURSES -->
      <section class="section" id="section-courses">
        <div class="section-header">
          <h2 class="section-title">Courses</h2>
          <button class="btn-primary" id="addCourseScrollBtn">+ Add new course</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="courseSearch" class="toolbar-input" placeholder="Search courses..." />
            <select id="courseFilterType" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
        </div>

        <table id="coursesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Level</th>
              <th>Type</th>
              <th>Price</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="courseForm">
          <div class="inline-input"><input type="text" id="courseTitle" placeholder="Course title" required /></div>
          <div class="inline-input"><input type="text" id="courseLevel" placeholder="Level (e.g. Class 11 / JEE)" /></div>
          <div class="inline-input">
            <select id="courseType">
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="inline-input"><input type="number" id="coursePrice" placeholder="Price (‚Çπ)" min="0" /></div>
          <div class="inline-input"><input type="text" id="courseSubtitle" placeholder="Subtitle (short tagline)" /></div>
          <button type="submit" class="btn-primary" id="courseSubmitBtn">Save course</button>
          <button type="button" class="btn-secondary" id="courseCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Course Content Editor (local only for now) -->
        <div class="card" id="courseContentEditor" style="display:none;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Course content</div>
              <div class="cc-editor-subtitle">Manage sections & lessons for: <strong id="ccCourseTitle"></strong></div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
  <button class="btn-secondary" id="ccSaveBtn">Save to DB</button>
  <button class="btn-primary" id="ccAddSectionBtn">+ Add section</button>
</div>

          </div>

          <div class="cc-json-toolbar">
            <button class="btn-secondary" id="ccShowJsonBtn">Show JSON</button>
            <button class="btn-secondary" id="ccCopyJsonBtn">Copy JSON</button>
          </div>
          <textarea id="ccJsonOutput" class="cc-json-output" readonly style="display:none;"></textarea>

          <div class="cc-sections-container" id="ccSectionsContainer"></div>
          <p class="muted">
            Note: content editor is local for now. Backend endpoints will be added later to save this JSON.
          </p>
        </div>

        <p class="muted">Courses are now saved in SQLite via API.</p>
      </section>

      <!-- TESTS -->
      <section class="section" id="section-tests">
        <div class="section-header">
          <h2 class="section-title">Tests</h2>
          <button class="btn-primary" id="addTestScrollBtn">+ Add new test</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="testSearch" class="toolbar-input" placeholder="Search tests..." />
            <select id="testFilterStatus" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
        </div>

        <table id="testsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Test Name</th>
              <th>Course</th>
              <th>Questions</th>
              <th>Duration</th>
              <th>Status</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="testForm">
          <div class="inline-input"><input type="text" id="testName" placeholder="Test title" required /></div>
          <div class="inline-input"><input type="text" id="testCourse" placeholder="Belongs to course" /></div>
          <div class="inline-input"><input type="number" id="testQuestions" placeholder="Questions" min="1" /></div>
          <div class="inline-input"><input type="text" id="testDuration" placeholder="Duration (e.g. 60 min)" /></div>
          <div class="inline-input">
            <select id="testStatus">
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <button type="submit" class="btn-primary" id="testSubmitBtn">Save test</button>
          <button type="button" class="btn-secondary" id="testCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Test content editor (local only) -->
        <div class="card" id="testContentEditor" style="display:none; margin-top:16px;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Test content</div>
              <div class="cc-editor-subtitle">Manage questions for: <strong id="tcTestTitle"></strong></div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
  <button class="btn-secondary" id="tcSaveBtn">Save to DB</button>
  <button class="btn-primary" id="tcAddQuestionBtn">+ Add question</button>
</div>

          </div>
          <div class="cc-sections-container" id="tcQuestionsContainer"></div>
          <p class="muted">Note: questions editor is local for now. Backend endpoints will be added later.</p>
        </div>

        <p class="muted">Tests are now saved in SQLite via API.</p>
      </section>

      <!-- UPDATES -->
      <section class="section" id="section-updates">
        <div class="section-header">
          <h2 class="section-title">Updates</h2>
          <button class="btn-primary" id="addUpdateScrollBtn">+ Add new update</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="updateSearch" class="toolbar-input" placeholder="Search updates..." />
          </div>
        </div>

        <table id="updatesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Visible to</th>
              <th>Created at</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="updateForm">
          <div class="inline-input"><input type="text" id="updateTitle" placeholder="Update title" required /></div>
          <div class="inline-input"><input type="text" id="updateAudience" placeholder="Visible to (e.g. All / JEE / NEET)" /></div>
          <div class="inline-input"><textarea id="updateBody" rows="2" placeholder="Short description"></textarea></div>
          <button type="submit" class="btn-primary" id="updateSubmitBtn">Save update</button>
          <button type="button" class="btn-secondary" id="updateCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <p class="muted">Updates are now saved in SQLite via API.</p>
      </section>

      <section class="section" id="section-settings">
        <div class="section-header"><h2 class="section-title">Settings</h2></div>
        <div class="card">
          <div class="card-title">Admin Settings (placeholder)</div>
          <p class="muted">Future: admin users, app config, ads config, etc.</p>
        </div>
      </section>
    </main>
  </div>

<script>
/* =========================
   PAPI ADMIN PANEL (FULL JS)
   - Nav working
   - Dashboard stats working
   - Courses/Tests/Updates CRUD
   - Course Content Editor: dynamic fields + validation + open buttons + save
   - Test Questions Editor: add/remove + validation + save
   ========================= */

const API_BASE = "http://localhost:8080/api"; // change if needed

/* ========= FIREBASE ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBnDo5VJiM2noDWRWk281aVaUfPZ-sX08A",
  authDomain: "papi0009.firebaseapp.com",
  projectId: "papi0009",
  storageBucket: "papi0009.firebasestorage.app",
  messagingSenderId: "598318485319",
  appId: "1:598318485319:web:b26e84907d49a92d42c662",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const ALLOWED_ADMINS = ["admin@papi.in"];

/* ========= DOM ========= */
const overlay = document.getElementById("overlay");
const logoutBtn = document.getElementById("logoutBtn");
const adminEmailEl = document.getElementById("adminEmail");
const avatarInitialEl = document.getElementById("avatarInitial");

/* Stats */
const statCoursesEl = document.getElementById("stat-courses");
const statTestsEl = document.getElementById("stat-tests");
const statUpdatesEl = document.getElementById("stat-updates");

/* Tables */
const coursesTbody = document.querySelector("#coursesTable tbody");
const testsTbody = document.querySelector("#testsTable tbody");
const updatesTbody = document.querySelector("#updatesTable tbody");

/* Forms */
const courseForm = document.getElementById("courseForm");
const courseTitle = document.getElementById("courseTitle");
const courseLevel = document.getElementById("courseLevel");
const courseType = document.getElementById("courseType");
const coursePrice = document.getElementById("coursePrice");
const courseSubtitle = document.getElementById("courseSubtitle");

const testForm = document.getElementById("testForm");
const testName = document.getElementById("testName");
const testCourse = document.getElementById("testCourse");
const testQuestions = document.getElementById("testQuestions");
const testDuration = document.getElementById("testDuration");
const testStatus = document.getElementById("testStatus");

const updateForm = document.getElementById("updateForm");
const updateTitle = document.getElementById("updateTitle");
const updateAudience = document.getElementById("updateAudience");
const updateBody = document.getElementById("updateBody");

/* Content Editors (Course/Test) */
const courseContentEditor = document.getElementById("courseContentEditor");
const ccCourseTitleEl = document.getElementById("ccCourseTitle");
const ccSectionsContainer = document.getElementById("ccSectionsContainer");
const ccShowJsonBtn = document.getElementById("ccShowJsonBtn");
const ccCopyJsonBtn = document.getElementById("ccCopyJsonBtn");
const ccJsonOutput = document.getElementById("ccJsonOutput");
const ccAddSectionBtn = document.getElementById("ccAddSectionBtn");

const testContentEditor = document.getElementById("testContentEditor");
const tcTestTitleEl = document.getElementById("tcTestTitle");
const tcQuestionsContainer = document.getElementById("tcQuestionsContainer");
const tcAddQuestionBtn = document.getElementById("tcAddQuestionBtn");

/* ========= UTIL ========= */
function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function isLikelyUrl(s) {
  const v = String(s || "").trim();
  if (!v) return false;
  try {
    const u = new URL(v);
    return u.protocol === "http:" || u.protocol === "https:";
  } catch (_) {
    return false;
  }
}

function toast(msg, type = "info") {
  // quick toast using alert-like UI
  // you can replace with nicer toast later
  if (type === "error") console.error(msg);
  if (type === "success") console.log(msg);
  alert(msg);
}

async function api(path, opts = {}) {
  const res = await fetch(`${API_BASE}${path}`, {
    headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
    ...opts,
  });
  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`${res.status} ${res.statusText}\n${text}`);
  }
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return await res.json();
  return await res.text();
}

/* ========= AUTH ========= */
auth.onAuthStateChanged((user) => {
  if (!user || !ALLOWED_ADMINS.includes(user.email)) {
    if (user) auth.signOut();
    window.location.href = "index.html";
    return;
  }
  adminEmailEl.textContent = user.email;
  avatarInitialEl.textContent = (user.email || "A")[0].toUpperCase();
  overlay.style.display = "none";
  initNav();
  bootstrapLoad();
});

logoutBtn.onclick = async () => {
  await auth.signOut();
  window.location.href = "index.html";
};

/* ========= GLOBAL STATE ========= */
let courses = [];
let tests = [];
let updates = [];

let editingCourseId = null;
let editingTestId = null;
let editingUpdateId = null;

let currentContentCourseId = null;
let currentContentCourse = null; // course row
let currentCourseContent = { sections: [] };

let currentContentTestId = null;
let currentContentTest = null; // test row
let currentTestQuestions = []; // array of questions

/* ========= NAV (FIX STUCK DASHBOARD) ========= */
function initNav() {
  const navLinks = document.querySelectorAll(".nav-link");
  const sections = document.querySelectorAll(".section");

  navLinks.forEach((btn) => {
    btn.addEventListener("click", () => {
      const sec = btn.getAttribute("data-section");

      navLinks.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      sections.forEach((s) => s.classList.remove("active"));
      const target = document.getElementById(`section-${sec}`);
      if (target) target.classList.add("active");
    });
  });
}

/* ========= FETCH ========= */
async function fetchCourses() {
  courses = await api("/courses");
}
async function fetchTests() {
  tests = await api("/tests");
}
async function fetchUpdates() {
  updates = await api("/updates");
}

/* ========= DASHBOARD STATS ========= */
function renderStats() {
  statCoursesEl.textContent = String(courses.length);
  statTestsEl.textContent = String(tests.length);
  statUpdatesEl.textContent = String(updates.length);
}

/* ========= COURSES CRUD ========= */
async function renderCourses() {
  await fetchCourses();
  renderStats();

  coursesTbody.innerHTML = "";
  courses.forEach((c, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${escapeHtml(c.title)}</td>
      <td>${escapeHtml(c.level || "-")}</td>
      <td>${escapeHtml(c.type || "free")}</td>
      <td>‚Çπ${Number(c.price || 0)}</td>
      <td>
        <button class="btn-secondary" data-edit> Edit </button>
        <button class="btn-secondary" data-content> Content </button>
        <button class="btn-secondary" data-del> Delete </button>
      </td>
    `;
    tr.querySelector("[data-edit]").onclick = () => startEditCourse(c);
    tr.querySelector("[data-content]").onclick = () => openCourseContentEditor(c.id);
    tr.querySelector("[data-del]").onclick = () => deleteCourse(c.id);
    coursesTbody.appendChild(tr);
  });
}

async function deleteCourse(id) {
  if (!confirm("Delete course?")) return;
  await api(`/courses/${id}`, { method: "DELETE" });
  await renderCourses();
}

function startEditCourse(c) {
  editingCourseId = c.id;
  courseTitle.value = c.title || "";
  courseLevel.value = c.level || "";
  courseType.value = c.type || "free";
  coursePrice.value = Number(c.price || 0);
  courseSubtitle.value = c.subtitle || "";
  toast("Editing course. Press Save course.", "success");
}

courseForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    title: courseTitle.value.trim(),
    level: courseLevel.value.trim(),
    type: courseType.value,
    price: Number(coursePrice.value || 0),
    subtitle: courseSubtitle.value.trim(),
  };
  if (!payload.title) return toast("Course title required", "error");

  if (editingCourseId) {
    // if your backend has PUT /courses/:id, use it. If not, you can delete+recreate.
    // For now we will call POST to create new if PUT not available.
    try {
      await api(`/courses/${editingCourseId}`, { method: "PUT", body: JSON.stringify(payload) });
    } catch (_) {
      // fallback: show message
      toast("Backend PUT /courses/:id not found. Add route OR delete+create.", "error");
      return;
    }
    editingCourseId = null;
  } else {
    await api("/courses", { method: "POST", body: JSON.stringify(payload) });
  }

  courseForm.reset();
  await renderCourses();
});

/* ========= TESTS CRUD ========= */
async function renderTests() {
  await fetchTests();
  renderStats();

  testsTbody.innerHTML = "";
  tests.forEach((t, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${escapeHtml(t.name)}</td>
      <td>${escapeHtml(t.course || "-")}</td>
      <td>${escapeHtml(t.questions ?? "-")}</td>
      <td>${escapeHtml(t.duration || "-")}</td>
      <td>${escapeHtml(t.status || "free")}</td>
      <td>
        <button class="btn-secondary" data-edit> Edit </button>
        <button class="btn-secondary" data-content> Questions </button>
        <button class="btn-secondary" data-del> Delete </button>
      </td>
    `;
    tr.querySelector("[data-edit]").onclick = () => startEditTest(t);
    tr.querySelector("[data-content]").onclick = () => openTestContentEditor(t.id);
    tr.querySelector("[data-del]").onclick = () => deleteTest(t.id);
    testsTbody.appendChild(tr);
  });
}

async function deleteTest(id) {
  if (!confirm("Delete test?")) return;
  await api(`/tests/${id}`, { method: "DELETE" });
  await renderTests();
}

function startEditTest(t) {
  editingTestId = t.id;
  testName.value = t.name || "";
  testCourse.value = t.course || "";
  testQuestions.value = t.questions || 0;
  testDuration.value = t.duration || "";
  testStatus.value = t.status || "free";
  toast("Editing test. Press Save test.", "success");
}

testForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    name: testName.value.trim(),
    course: testCourse.value.trim(),
    questions: Number(testQuestions.value || 0),
    duration: testDuration.value.trim(),
    status: testStatus.value,
  };
  if (!payload.name) return toast("Test title required", "error");

  if (editingTestId) {
    try {
      await api(`/tests/${editingTestId}`, { method: "PUT", body: JSON.stringify(payload) });
    } catch (_) {
      toast("Backend PUT /tests/:id not found. Add route OR delete+create.", "error");
      return;
    }
    editingTestId = null;
  } else {
    await api("/tests", { method: "POST", body: JSON.stringify(payload) });
  }

  testForm.reset();
  await renderTests();
});

/* ========= UPDATES CRUD ========= */
async function renderUpdates() {
  await fetchUpdates();
  renderStats();

  updatesTbody.innerHTML = "";
  updates.forEach((u, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${escapeHtml(u.title)}</td>
      <td>${escapeHtml(u.audience || "All")}</td>
      <td>${escapeHtml(u.created_at || "-")}</td>
      <td>
        <button class="btn-secondary" data-edit> Edit </button>
        <button class="btn-secondary" data-del> Delete </button>
      </td>
    `;
    tr.querySelector("[data-edit]").onclick = () => startEditUpdate(u);
    tr.querySelector("[data-del]").onclick = () => deleteUpdate(u.id);
    updatesTbody.appendChild(tr);
  });
}

async function deleteUpdate(id) {
  if (!confirm("Delete update?")) return;
  await api(`/updates/${id}`, { method: "DELETE" });
  await renderUpdates();
}

function startEditUpdate(u) {
  editingUpdateId = u.id;
  updateTitle.value = u.title || "";
  updateAudience.value = u.audience || "";
  updateBody.value = u.body || "";
  toast("Editing update. Press Save update.", "success");
}

updateForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    title: updateTitle.value.trim(),
    audience: updateAudience.value.trim(),
    body: updateBody.value.trim(),
  };
  if (!payload.title) return toast("Update title required", "error");

  if (editingUpdateId) {
    await api(`/updates/${editingUpdateId}`, { method: "PUT", body: JSON.stringify(payload) });
    editingUpdateId = null;
  } else {
    await api("/updates", { method: "POST", body: JSON.stringify(payload) });
  }

  updateForm.reset();
  await renderUpdates();
});

/* ======================================================
   COURSE CONTENT EDITOR (FULLY WORKING)
   - Dynamic field based on type
   - Validation
   - Open button (preview)
   - Save to DB (PUT /courses/:id/content)
   ====================================================== */

function typeFieldConfig(type) {
  switch (type) {
    case "video": return { key: "video_url", label: "Video URL", placeholder: "https://..." };
    case "pdf":   return { key: "pdf_url", label: "PDF URL", placeholder: "https://.../file.pdf" };
    case "link":  return { key: "external_link", label: "External link", placeholder: "https://..." };
    case "quiz":  return { key: "quiz_id", label: "Quiz/Test ID", placeholder: "e.g. 12 or test_12" };
    case "note":  return { key: "description", label: "Note text", placeholder: "Write note..." };
    default:      return { key: "external_link", label: "Value", placeholder: "..." };
  }
}

function ensureItemKeys(it) {
  it.id ??= String(Date.now() + Math.random());
  it.type ??= "video";
  it.title ??= "";
  it.description ??= "";
  it.duration_minutes ??= 0;
  it.is_locked ??= false;
  it.is_preview ??= false;

  it.video_url ??= "";
  it.pdf_url ??= "";
  it.external_link ??= "";
  it.quiz_id ??= "";
}

function getTypeValue(it) {
  ensureItemKeys(it);
  const cfg = typeFieldConfig(it.type);
  return String(it[cfg.key] ?? "");
}

function setTypeValue(it, value) {
  ensureItemKeys(it);
  const cfg = typeFieldConfig(it.type);

  // clean other fields so payload stays neat
  if (cfg.key !== "video_url") it.video_url = "";
  if (cfg.key !== "pdf_url") it.pdf_url = "";
  if (cfg.key !== "external_link") it.external_link = "";
  if (cfg.key !== "quiz_id") it.quiz_id = "";
  if (cfg.key !== "description") it.description = "";

  it[cfg.key] = value;
}

function normalizeCourseContentFromBackend(raw) {
  // backend may return: {sections: []} OR {modules: []}
  const sections = raw?.sections ?? raw?.modules ?? [];
  // ensure structure: sections[{id,title,description,order,items:[]}]
  return {
    sections: (Array.isArray(sections) ? sections : []).map((s, idx) => ({
      id: String(s.id ?? `sec_${idx}_${Date.now()}`),
      title: s.title ?? "Untitled section",
      description: s.description ?? "",
      order: Number(s.order ?? idx),
      items: (Array.isArray(s.items) ? s.items : []).map((it) => {
        ensureItemKeys(it);
        // map snake/camel just in case
        it.duration_minutes ??= it.durationMinutes ?? 0;
        it.is_locked ??= it.isLocked ?? false;
        it.is_preview ??= it.isPreview ?? false;
        it.video_url ??= it.videoUrl ?? "";
        it.pdf_url ??= it.pdfUrl ?? "";
        it.external_link ??= it.externalLink ?? "";
        it.quiz_id ??= it.quizId ?? "";
        return it;
      }),
    })),
  };
}

function validateCourseContent(payload) {
  const errors = [];
  const sections = payload.sections || [];
  if (!sections.length) errors.push("Add at least 1 section.");

  sections.forEach((sec, sIdx) => {
    if (!String(sec.title || "").trim()) errors.push(`Section ${sIdx + 1}: title required`);
    const items = sec.items || [];
    if (!items.length) errors.push(`Section ${sIdx + 1}: add at least 1 lesson`);

    items.forEach((it, iIdx) => {
      ensureItemKeys(it);
      if (!String(it.title || "").trim()) errors.push(`Section ${sIdx + 1} Lesson ${iIdx + 1}: title required`);

      const cfg = typeFieldConfig(it.type);
      const v = String(it[cfg.key] || "").trim();

      if (it.type === "video" || it.type === "pdf" || it.type === "link") {
        if (!v) errors.push(`Section ${sIdx + 1} Lesson ${iIdx + 1}: ${cfg.label} required`);
        else if (!isLikelyUrl(v)) errors.push(`Section ${sIdx + 1} Lesson ${iIdx + 1}: ${cfg.label} must be a valid URL`);
      }
      if (it.type === "quiz") {
        if (!v) errors.push(`Section ${sIdx + 1} Lesson ${iIdx + 1}: Quiz/Test ID required`);
      }
      if (it.type === "note") {
        if (!v) errors.push(`Section ${sIdx + 1} Lesson ${iIdx + 1}: Note text required`);
      }
    });
  });

  return errors;
}

async function openCourseContentEditor(courseId) {
  currentContentCourseId = courseId;
  currentContentCourse = courses.find((c) => c.id === courseId) || { title: `Course #${courseId}` };

  // GET /courses/:id/content
  const raw = await api(`/courses/${courseId}/content`);
  currentCourseContent = normalizeCourseContentFromBackend(raw);

  ccCourseTitleEl.textContent = currentContentCourse.title || `Course #${courseId}`;
  courseContentEditor.style.display = "block";
  renderCourseContentUI();

  // scroll into view
  courseContentEditor.scrollIntoView({ behavior: "smooth", block: "start" });
}

async function saveCourseContent() {
  if (!currentContentCourseId) return;

  // sort order before save
  currentCourseContent.sections.forEach((s, idx) => (s.order = idx));

  const errors = validateCourseContent(currentCourseContent);
  if (errors.length) {
    toast("Fix these errors:\n\n‚Ä¢ " + errors.join("\n‚Ä¢ "), "error");
    return;
  }

  await api(`/courses/${currentContentCourseId}/content`, {
    method: "PUT",
    body: JSON.stringify(currentCourseContent),
  });
  toast("Course content saved ‚úÖ", "success");
}

function renderCourseContentUI() {
  ccSectionsContainer.innerHTML = "";

  const sections = currentCourseContent.sections || [];
  if (!sections.length) {
    ccSectionsContainer.innerHTML = `<div class="muted">No sections yet. Click ‚ÄúAdd section‚Äù.</div>`;
    return;
  }

  sections.forEach((sec, sIdx) => {
    const wrap = document.createElement("div");
    wrap.className = "cc-section-card";

    wrap.innerHTML = `
      <div class="cc-section-header">
        <div style="flex:1;min-width:200px;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <div class="cc-section-title">Section ${sIdx + 1}</div>
            <button class="btn-secondary" data-move-up>‚Üë</button>
            <button class="btn-secondary" data-move-down>‚Üì</button>
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <input data-sec-title value="${escapeHtml(sec.title || "")}"
              placeholder="Section title"
              style="flex:1;min-width:220px;border:1px solid #e5e7eb;border-radius:8px;padding:7px 9px;font-size:13px;" />
            <input data-sec-desc value="${escapeHtml(sec.description || "")}"
              placeholder="Section description (optional)"
              style="flex:2;min-width:260px;border:1px solid #e5e7eb;border-radius:8px;padding:7px 9px;font-size:13px;" />
          </div>
        </div>

        <div class="cc-section-actions">
          <button class="btn-secondary" data-add-lesson>+ Lesson</button>
          <button class="btn-secondary" data-del-sec>Delete</button>
        </div>
      </div>

      <div class="cc-lessons-wrapper">
        <table class="cc-lessons-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Type</th>
              <th>Type Field</th>
              <th>Min</th>
              <th>Locked</th>
              <th>Preview</th>
              <th style="width:150px;">Actions</th>
            </tr>
          </thead>
          <tbody data-lessons></tbody>
        </table>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button class="btn-primary" data-save>Save content</button>
          <button class="btn-secondary" data-validate>Validate</button>
        </div>
      </div>
    `;

    // Section inputs
    wrap.querySelector("[data-sec-title]").oninput = (e) => (sec.title = e.target.value);
    wrap.querySelector("[data-sec-desc]").oninput = (e) => (sec.description = e.target.value);

    // Move section
    wrap.querySelector("[data-move-up]").onclick = () => {
      if (sIdx === 0) return;
      const tmp = sections[sIdx - 1];
      sections[sIdx - 1] = sections[sIdx];
      sections[sIdx] = tmp;
      renderCourseContentUI();
    };
    wrap.querySelector("[data-move-down]").onclick = () => {
      if (sIdx === sections.length - 1) return;
      const tmp = sections[sIdx + 1];
      sections[sIdx + 1] = sections[sIdx];
      sections[sIdx] = tmp;
      renderCourseContentUI();
    };

    // Add lesson
    wrap.querySelector("[data-add-lesson]").onclick = () => {
      sec.items ??= [];
      sec.items.push({
        id: String(Date.now() + Math.random()),
        type: "video",
        title: "",
        duration_minutes: 0,
        is_locked: false,
        is_preview: false,
        video_url: "",
        pdf_url: "",
        external_link: "",
        quiz_id: "",
        description: "",
      });
      renderCourseContentUI();
    };

    // Delete section
    wrap.querySelector("[data-del-sec]").onclick = () => {
      if (!confirm("Delete this section and its lessons?")) return;
      sections.splice(sIdx, 1);
      renderCourseContentUI();
    };

    // Save + Validate buttons
    wrap.querySelector("[data-save]").onclick = () => saveCourseContent();
    wrap.querySelector("[data-validate]").onclick = () => {
      const errs = validateCourseContent(currentCourseContent);
      if (!errs.length) toast("Validation OK ‚úÖ", "success");
      else toast("Fix:\n\n‚Ä¢ " + errs.join("\n‚Ä¢ "), "error");
    };

    // Lessons table rows
    const tbody = wrap.querySelector("[data-lessons]");
    tbody.innerHTML = "";

    const items = sec.items || [];
    if (!items.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" style="color:#6b7280;">No lessons yet. Click ‚Äú+ Lesson‚Äù.</td>`;
      tbody.appendChild(tr);
    } else {
      items.forEach((it, lIdx) => {
        ensureItemKeys(it);
        const cfg = typeFieldConfig(it.type);
        const typeVal = getTypeValue(it);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <input data-title value="${escapeHtml(it.title||"")}"
              style="width:220px;border:1px solid #e5e7eb;border-radius:8px;padding:5px 7px;font-size:12px;" />
          </td>

          <td>
            <select data-type style="border:1px solid #e5e7eb;border-radius:8px;padding:5px 7px;font-size:12px;">
              ${["video","pdf","note","quiz","link"].map(t=>`<option value="${t}" ${it.type===t?"selected":""}>${t}</option>`).join("")}
            </select>
          </td>

          <td>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <div style="font-size:11px;color:#6b7280;">${escapeHtml(cfg.label)}</div>

              ${
                it.type === "note"
                  ? `<textarea data-dyn rows="2"
                        placeholder="${escapeHtml(cfg.placeholder)}"
                        style="width:260px;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;font-size:12px;resize:vertical;">${escapeHtml(typeVal)}</textarea>`
                  : `<input data-dyn value="${escapeHtml(typeVal)}"
                        placeholder="${escapeHtml(cfg.placeholder)}"
                        style="width:260px;border:1px solid #e5e7eb;border-radius:8px;padding:5px 7px;font-size:12px;" />`
              }
            </div>
          </td>

          <td>
            <input data-min type="number" value="${Number(it.duration_minutes||0)}"
              style="width:70px;border:1px solid #e5e7eb;border-radius:8px;padding:5px 7px;font-size:12px;" />
          </td>

          <td><input data-locked type="checkbox" ${it.is_locked ? "checked":""} /></td>
          <td><input data-preview type="checkbox" ${it.is_preview ? "checked":""} /></td>

          <td style="display:flex;gap:6px;align-items:center;">
            <button class="btn-secondary" data-open>Open</button>
            <button class="btn-secondary" data-del>Remove</button>
          </td>
        `;

        const titleI = tr.querySelector("[data-title]");
        const typeS  = tr.querySelector("[data-type]");
        const dynEl  = tr.querySelector("[data-dyn]");
        const minI   = tr.querySelector("[data-min]");
        const lockC  = tr.querySelector("[data-locked]");
        const prevC  = tr.querySelector("[data-preview]");
        const delB   = tr.querySelector("[data-del]");
        const openB  = tr.querySelector("[data-open]");

        titleI.oninput = () => (it.title = titleI.value);

        typeS.onchange = () => {
          const currentValue = dynEl ? dynEl.value : "";
          it.type = typeS.value;
          setTypeValue(it, currentValue);
          renderCourseContentUI(); // rerender for textarea/input + label
        };

        if (dynEl) dynEl.oninput = () => setTypeValue(it, dynEl.value);

        minI.oninput = () => (it.duration_minutes = Number(minI.value || 0));
        lockC.onchange = () => (it.is_locked = !!lockC.checked);
        prevC.onchange = () => (it.is_preview = !!prevC.checked);

        delB.onclick = () => {
          if (!confirm("Remove lesson?")) return;
          sec.items.splice(lIdx, 1);
          renderCourseContentUI();
        };

        openB.onclick = () => {
          const cfg2 = typeFieldConfig(it.type);
          const v = String(it[cfg2.key] || "").trim();

          if (it.type === "video" || it.type === "pdf" || it.type === "link") {
            if (!isLikelyUrl(v)) return toast(`Invalid URL for ${cfg2.label}`, "error");
            window.open(v, "_blank");
            return;
          }
          if (it.type === "quiz") {
            toast(`Quiz/Test ID: ${v || "(empty)"}`, "info");
            return;
          }
          if (it.type === "note") {
            toast(v ? "Note opened (see field)." : "Note empty", v ? "success" : "error");
            return;
          }
        };

        tbody.appendChild(tr);
      });
    }

    ccSectionsContainer.appendChild(wrap);
  });
}

/* JSON buttons */
ccShowJsonBtn.onclick = () => {
  const show = ccJsonOutput.style.display !== "block";
  ccJsonOutput.style.display = show ? "block" : "none";
  if (show) ccJsonOutput.value = JSON.stringify(currentCourseContent, null, 2);
};

ccCopyJsonBtn.onclick = async () => {
  try {
    await navigator.clipboard.writeText(JSON.stringify(currentCourseContent, null, 2));
    toast("JSON copied ‚úÖ", "success");
  } catch (e) {
    toast("Copy failed: " + e, "error");
  }
};

ccAddSectionBtn.onclick = () => {
  currentCourseContent.sections ??= [];
  currentCourseContent.sections.push({
    id: String(Date.now() + Math.random()),
    title: "",
    description: "",
    order: currentCourseContent.sections.length,
    items: [],
  });
  renderCourseContentUI();
};

/* ======================================================
   TEST QUESTIONS EDITOR (FULLY WORKING)
   - add/remove
   - validation
   - save to DB (PUT /tests/:id/questions)
   Note: your backend currently only has PUT /api/tests/:id/questions (good)
   But you DO NOT have GET /api/tests/:id/questions
   So we will load using GET /tests/:id (your backend has it) and read questions_json if present.
   ====================================================== */

function normalizeQuestionsFromTestRow(row) {
  // If you later store questions_json column, read it
  // fallback: empty array
  try {
    if (row && row.questions_json) {
      const q = JSON.parse(row.questions_json);
      if (Array.isArray(q)) return q;
      // maybe {questions:[...]}
      if (q && Array.isArray(q.questions)) return q.questions;
    }
  } catch (_) {}
  return [];
}

function validateQuestions(list) {
  const errs = [];
  if (!list.length) errs.push("Add at least 1 question.");
  list.forEach((q, i) => {
    if (!String(q.question || "").trim()) errs.push(`Q${i + 1}: question text required`);
    const opts = q.options || {};
    const optArr = [opts.a, opts.b, opts.c, opts.d].map(x => String(x||"").trim());
    if (optArr.some(x => !x)) errs.push(`Q${i + 1}: all options A/B/C/D required`);
    if (!["a","b","c","d"].includes(String(q.answer||"").toLowerCase())) errs.push(`Q${i + 1}: answer must be a/b/c/d`);
  });
  return errs;
}

async function openTestContentEditor(testId) {
  currentContentTestId = testId;
  currentContentTest = tests.find((t) => t.id === testId) || { name: `Test #${testId}` };

  // Load test row (GET /tests/:id)
  const row = await api(`/tests/${testId}`);
  currentTestQuestions = normalizeQuestionsFromTestRow(row);

  tcTestTitleEl.textContent = currentContentTest.name || `Test #${testId}`;
  testContentEditor.style.display = "block";
  renderTestQuestionsUI();

  testContentEditor.scrollIntoView({ behavior: "smooth", block: "start" });
}

async function saveTestQuestions() {
  if (!currentContentTestId) return;

  const errs = validateQuestions(currentTestQuestions);
  if (errs.length) {
    toast("Fix these errors:\n\n‚Ä¢ " + errs.join("\n‚Ä¢ "), "error");
    return;
  }

  // PUT /tests/:id/questions (backend expects body JSON; you currently stringify whole body)
  await api(`/tests/${currentContentTestId}/questions`, {
    method: "PUT",
    body: JSON.stringify({ questions: currentTestQuestions }),
  });
  toast("Test questions saved ‚úÖ", "success");
}

function renderTestQuestionsUI() {
  tcQuestionsContainer.innerHTML = "";

  if (!currentTestQuestions.length) {
    tcQuestionsContainer.innerHTML = `<div class="muted">No questions yet. Click ‚Äú+ Add question‚Äù.</div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-primary" id="tcSaveBtn">Save questions</button>
        <button class="btn-secondary" id="tcValidateBtn">Validate</button>
      </div>`;
    document.getElementById("tcSaveBtn").onclick = () => saveTestQuestions();
    document.getElementById("tcValidateBtn").onclick = () => {
      const errs = validateQuestions(currentTestQuestions);
      if (!errs.length) toast("Validation OK ‚úÖ", "success");
      else toast("Fix:\n\n‚Ä¢ " + errs.join("\n‚Ä¢ "), "error");
    };
    return;
  }

  currentTestQuestions.forEach((q, idx) => {
    q.id ??= String(Date.now() + Math.random());
    q.options ??= { a: "", b: "", c: "", d: "" };
    q.answer ??= "a";

    const card = document.createElement("div");
    card.className = "cc-section-card";
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;">
        <div style="font-weight:700;">Q${idx + 1}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-secondary" data-open>Preview</button>
          <button class="btn-secondary" data-del>Remove</button>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
        <textarea data-q rows="2" placeholder="Question text"
          style="width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;resize:vertical;">${escapeHtml(q.question || "")}</textarea>

        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;">
          <input data-a placeholder="Option A" value="${escapeHtml(q.options.a || "")}"
            style="border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;" />
          <input data-b placeholder="Option B" value="${escapeHtml(q.options.b || "")}"
            style="border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;" />
          <input data-c placeholder="Option C" value="${escapeHtml(q.options.c || "")}"
            style="border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;" />
          <input data-d placeholder="Option D" value="${escapeHtml(q.options.d || "")}"
            style="border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;" />
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <div style="font-size:12px;color:#6b7280;">Correct answer:</div>
          <select data-ans style="border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:13px;">
            ${["a","b","c","d"].map(a=>`<option value="${a}" ${String(q.answer).toLowerCase()===a?"selected":""}>${a.toUpperCase()}</option>`).join("")}
          </select>
        </div>
      </div>
    `;

    card.querySelector("[data-q]").oninput = (e) => (q.question = e.target.value);
    card.querySelector("[data-a]").oninput = (e) => (q.options.a = e.target.value);
    card.querySelector("[data-b]").oninput = (e) => (q.options.b = e.target.value);
    card.querySelector("[data-c]").oninput = (e) => (q.options.c = e.target.value);
    card.querySelector("[data-d]").oninput = (e) => (q.options.d = e.target.value);
    card.querySelector("[data-ans]").onchange = (e) => (q.answer = e.target.value);

    card.querySelector("[data-del]").onclick = () => {
      if (!confirm("Remove question?")) return;
      currentTestQuestions.splice(idx, 1);
      renderTestQuestionsUI();
    };

    card.querySelector("[data-open]").onclick = () => {
      toast(
        `Q${idx + 1}\n\n${q.question || ""}\n\nA) ${q.options.a || ""}\nB) ${q.options.b || ""}\nC) ${q.options.c || ""}\nD) ${q.options.d || ""}\n\nAnswer: ${(q.answer||"a").toUpperCase()}`,
        "info"
      );
    };

    tcQuestionsContainer.appendChild(card);
  });

  // Save + Validate buttons
  const actions = document.createElement("div");
  actions.style.marginTop = "10px";
  actions.style.display = "flex";
  actions.style.gap = "10px";
  actions.style.flexWrap = "wrap";
  actions.innerHTML = `
    <button class="btn-primary" id="tcSaveBtn2">Save questions</button>
    <button class="btn-secondary" id="tcValidateBtn2">Validate</button>
  `;
  tcQuestionsContainer.appendChild(actions);

  document.getElementById("tcSaveBtn2").onclick = () => saveTestQuestions();
  document.getElementById("tcValidateBtn2").onclick = () => {
    const errs = validateQuestions(currentTestQuestions);
    if (!errs.length) toast("Validation OK ‚úÖ", "success");
    else toast("Fix:\n\n‚Ä¢ " + errs.join("\n‚Ä¢ "), "error");
  };
}

tcAddQuestionBtn.onclick = () => {
  currentTestQuestions.push({
    id: String(Date.now() + Math.random()),
    question: "",
    options: { a: "", b: "", c: "", d: "" },
    answer: "a",
  });
  renderTestQuestionsUI();
};

/* ========= BOOTSTRAP ========= */
async function bootstrapLoad() {
  try {
    await renderCourses();
    await renderTests();
    await renderUpdates();
  } catch (e) {
    console.error(e);
    toast("Bootstrap failed:\n" + e.message, "error");
  }
}
</script>
</body>
</html>

