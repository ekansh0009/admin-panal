<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PAPI Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
    .logo-circle {
      width: 34px; height: 34px; border-radius: 999px;
      background: #4c6fff; display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px;
    }
    .sidebar-title { font-weight: 700; font-size: 18px; }
    .sidebar-sub { font-size: 11px; color: #9ca3af; }
    .nav { list-style: none; margin-top: 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link {
      width: 100%; border-radius: 10px; padding: 8px 10px;
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; font-size: 14px; color: #e5e7eb;
      border: none; background: transparent; text-align: left;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .nav-link span.icon { font-size: 16px; width: 18px; text-align: center; }
    .nav-link.active, .nav-link:hover { background: #111827; color: #ffffff; }
    .sidebar-footer { margin-top: auto; font-size: 12px; color: #6b7280; }

    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .topbar {
      height: 56px; background: #ffffff; border-bottom: 1px solid #e5e7eb;
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    }
    .topbar-title { font-weight: 600; font-size: 16px; }
    .topbar-right { display: flex; align-items: center; gap: 12px; font-size: 13px; color: #6b7280; }
    .avatar {
      width: 32px; height: 32px; border-radius: 999px; background: #4c6fff; color: #fff;
      display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600;
    }
    .logout-btn {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px;
      background: #ffffff; color: #374151; font-size: 12px; cursor: pointer;
    }

    .content { padding: 18px 20px 24px; min-height: calc(100vh - 56px); }
    .section { display: none; }
    .section.active { display: block; }
    .section-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; gap: 10px; flex-wrap: wrap;
    }
    .section-title { font-size: 20px; font-weight: 700; }
    .btn-primary {
      border-radius: 10px; border: none; padding: 8px 14px; background: #4c6fff; color: #ffffff;
      font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-secondary {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px; background: #ffffff;
      color: #374151; font-size: 12px; cursor: pointer;
    }

    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; margin-bottom: 18px; }
    .card { background: #ffffff; border-radius: 14px; padding: 14px; border: 1px solid #e5e7eb; }
    .card-title { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
    .card-value { font-size: 18px; font-weight: 700; }
    .card-sub { font-size: 11px; color: #9ca3af; margin-top: 4px; }

    .section-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
    .toolbar-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .toolbar-input {
      border-radius: 999px; border: 1px solid #e5e7eb; padding: 7px 10px;
      font-size: 13px; background: #ffffff; min-width: 160px;
    }
    .toolbar-input::placeholder { color: #9ca3af; }

    table {
      width: 100%; border-collapse: collapse; font-size: 13px; background: #ffffff;
      border-radius: 14px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    thead { background: #f9fafb; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { font-size: 12px; font-weight: 600; color: #6b7280; }
    tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: #f9fafb; }

    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .badge-free { background: #e0f2fe; color: #0369a1; }
    .badge-paid { background: #fef3c7; color: #b45309; }
    .badge-status { background: #ecfdf5; color: #15803d; }

    .muted { font-size: 12px; color: #9ca3af; margin-top: 8px; }

    .inline-form {
      margin-top: 14px; background: #ffffff; border-radius: 14px; border: 1px solid #e5e7eb;
      padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .inline-input { flex: 1 1 180px; min-width: 0; }
    .inline-input input, .inline-input select, .inline-input textarea {
      width: 100%; border-radius: 8px; border: 1px solid #e5e7eb; padding: 7px 9px; font-size: 13px; resize: vertical;
    }

    #overlay {
      position: fixed; inset: 0; background: rgba(243, 244, 246, 0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; font-size: 14px; color: #6b7280;
    }

    #courseContentEditor { margin-top: 16px; }
    .cc-editor-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .cc-editor-subtitle { font-size: 12px; color: #6b7280; }
    .cc-sections-container { display: flex; flex-direction: column; gap: 10px; margin-top: 4px; }
    .cc-section-card { border-radius: 12px; border: 1px solid #e5e7eb; padding: 10px 12px; background: #f9fafb; }
    .cc-section-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    .cc-section-title { font-size: 14px; font-weight: 600; }
    .cc-section-desc { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .cc-section-actions { display: flex; flex-wrap: wrap; gap: 6px; }
    .cc-lessons-wrapper { margin-top: 6px; }

    .cc-lessons-table {
      width: 100%; border-collapse: collapse; font-size: 12px; background: #ffffff;
      border-radius: 10px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    .cc-lessons-table th, .cc-lessons-table td { padding: 6px 8px; border-bottom: 1px solid #e5e7eb; }
    .cc-lessons-table th { background: #f3f4f6; font-weight: 600; color: #6b7280; }
    .cc-lessons-table tr:last-child td { border-bottom: none; }

    .cc-tag-lock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #fee2e2; color: #b91c1c;
    }
    .cc-tag-unlock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #dcfce7; color: #15803d;
    }

    .cc-json-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
    .cc-json-output {
      margin-top: 4px; width: 100%; min-height: 140px; max-height: 260px;
      border-radius: 10px; border: 1px solid #e5e7eb; padding: 8px 10px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #f9fafb; resize: vertical; white-space: pre; overflow: auto;
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      body { flex-direction: column; }
      .main { width: 100%; }
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .inline-form { flex-direction: column; align-items: stretch; }
      .section-toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-input { width: 100%; }
      .cc-section-header { flex-direction: column; align-items: flex-start; }
      .cc-section-actions { width: 100%; }
    }
  </style>
</head>

<body>
  <div id="overlay">Checking admin access‚Ä¶</div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle">P</div>
      <div>
        <div class="sidebar-title">PAPI Admin</div>
        <div class="sidebar-sub">Control panel</div>
      </div>
    </div>

    <ul class="nav">
      <li class="nav-item"><button class="nav-link active" data-section="overview"><span class="icon">üè†</span> Dashboard</button></li>
      <li class="nav-item"><button class="nav-link" data-section="courses"><span class="icon">üìö</span> Courses</button></li>
      <li class="nav-item"><button class="nav-link" data-section="tests"><span class="icon">üìù</span> Tests</button></li>
      <li class="nav-item"><button class="nav-link" data-section="updates"><span class="icon">üì¢</span> Updates</button></li>
      <li class="nav-item"><button class="nav-link" data-section="settings"><span class="icon">‚öôÔ∏è</span> Settings</button></li>
    </ul>

    <div class="sidebar-footer">
      ¬© PAPI ‚Ä¢ v0.3<br />
      (Connected to local backend)
    </div>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-title">PAPI Admin Panel</div>
      <div class="topbar-right">
        <span id="adminEmail">Admin</span>
        <div class="avatar" id="avatarInitial">A</div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </header>

    <main class="content">
      <section class="section active" id="section-overview">
        <div class="section-header"><h2 class="section-title">Overview</h2></div>
        <div class="grid">
          <div class="card"><div class="card-title">Total Courses</div><div class="card-value" id="stat-courses">0</div><div class="card-sub">Free + paid</div></div>
          <div class="card"><div class="card-title">Total Tests</div><div class="card-value" id="stat-tests">0</div><div class="card-sub">Active test series</div></div>
          <div class="card"><div class="card-title">Total Updates</div><div class="card-value" id="stat-updates">0</div><div class="card-sub">Announcements</div></div>
        </div>
        <p class="muted">Now stats are coming from backend DB (SQLite). Refresh will keep the data.</p>
      </section>

      <!-- COURSES -->
      <section class="section" id="section-courses">
        <div class="section-header">
          <h2 class="section-title">Courses</h2>
          <button class="btn-primary" id="addCourseScrollBtn">+ Add new course</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="courseSearch" class="toolbar-input" placeholder="Search courses..." />
            <select id="courseFilterType" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
        </div>

        <table id="coursesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Level</th>
              <th>Type</th>
              <th>Price</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="courseForm">
          <div class="inline-input"><input type="text" id="courseTitle" placeholder="Course title" required /></div>
          <div class="inline-input"><input type="text" id="courseLevel" placeholder="Level (e.g. Class 11 / JEE)" /></div>
          <div class="inline-input">
            <select id="courseType">
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="inline-input"><input type="number" id="coursePrice" placeholder="Price (‚Çπ)" min="0" /></div>
          <div class="inline-input"><input type="text" id="courseSubtitle" placeholder="Subtitle (short tagline)" /></div>
          <button type="submit" class="btn-primary" id="courseSubmitBtn">Save course</button>
          <button type="button" class="btn-secondary" id="courseCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Course Content Editor (local only for now) -->
        <div class="card" id="courseContentEditor" style="display:none;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Course content</div>
              <div class="cc-editor-subtitle">Manage sections & lessons for: <strong id="ccCourseTitle"></strong></div>
            </div>
            <button class="btn-primary" id="ccAddSectionBtn">+ Add section</button>
          </div>

          <div class="cc-json-toolbar">
            <button class="btn-secondary" id="ccShowJsonBtn">Show JSON</button>
            <button class="btn-secondary" id="ccCopyJsonBtn">Copy JSON</button>
          </div>
          <textarea id="ccJsonOutput" class="cc-json-output" readonly style="display:none;"></textarea>

          <div class="cc-sections-container" id="ccSectionsContainer"></div>
          <p class="muted">
            Note: content editor is local for now. Backend endpoints will be added later to save this JSON.
          </p>
        </div>

        <p class="muted">Courses are now saved in SQLite via API.</p>
      </section>

      <!-- TESTS -->
      <section class="section" id="section-tests">
        <div class="section-header">
          <h2 class="section-title">Tests</h2>
          <button class="btn-primary" id="addTestScrollBtn">+ Add new test</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="testSearch" class="toolbar-input" placeholder="Search tests..." />
            <select id="testFilterStatus" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
        </div>

        <table id="testsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Test Name</th>
              <th>Course</th>
              <th>Questions</th>
              <th>Duration</th>
              <th>Status</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="testForm">
          <div class="inline-input"><input type="text" id="testName" placeholder="Test title" required /></div>
          <div class="inline-input"><input type="text" id="testCourse" placeholder="Belongs to course" /></div>
          <div class="inline-input"><input type="number" id="testQuestions" placeholder="Questions" min="1" /></div>
          <div class="inline-input"><input type="text" id="testDuration" placeholder="Duration (e.g. 60 min)" /></div>
          <div class="inline-input">
            <select id="testStatus">
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <button type="submit" class="btn-primary" id="testSubmitBtn">Save test</button>
          <button type="button" class="btn-secondary" id="testCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Test content editor (local only) -->
        <div class="card" id="testContentEditor" style="display:none; margin-top:16px;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Test content</div>
              <div class="cc-editor-subtitle">Manage questions for: <strong id="tcTestTitle"></strong></div>
            </div>
            <button class="btn-primary" id="tcAddQuestionBtn">+ Add question</button>
          </div>
          <div class="cc-sections-container" id="tcQuestionsContainer"></div>
          <p class="muted">Note: questions editor is local for now. Backend endpoints will be added later.</p>
        </div>

        <p class="muted">Tests are now saved in SQLite via API.</p>
      </section>

      <!-- UPDATES -->
      <section class="section" id="section-updates">
        <div class="section-header">
          <h2 class="section-title">Updates</h2>
          <button class="btn-primary" id="addUpdateScrollBtn">+ Add new update</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="updateSearch" class="toolbar-input" placeholder="Search updates..." />
          </div>
        </div>

        <table id="updatesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Visible to</th>
              <th>Created at</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="updateForm">
          <div class="inline-input"><input type="text" id="updateTitle" placeholder="Update title" required /></div>
          <div class="inline-input"><input type="text" id="updateAudience" placeholder="Visible to (e.g. All / JEE / NEET)" /></div>
          <div class="inline-input"><textarea id="updateBody" rows="2" placeholder="Short description"></textarea></div>
          <button type="submit" class="btn-primary" id="updateSubmitBtn">Save update</button>
          <button type="button" class="btn-secondary" id="updateCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <p class="muted">Updates are now saved in SQLite via API.</p>
      </section>

      <section class="section" id="section-settings">
        <div class="section-header"><h2 class="section-title">Settings</h2></div>
        <div class="card">
          <div class="card-title">Admin Settings (placeholder)</div>
          <p class="muted">Future: admin users, app config, ads config, etc.</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ‚úÖ Local backend
    const API_BASE = "http://localhost:8080/api";

    // üîê Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnDo5VJiM2noDWRWk281aVaUfPZ-sX08A",
      authDomain: "papi0009.firebaseapp.com",
      projectId: "papi0009",
      storageBucket: "papi0009.firebasestorage.app",
      messagingSenderId: "598318485319",
      appId: "1:598318485319:web:b26e84907d49a92d42c662",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const ALLOWED_ADMINS = ["admin@papi.in"];

    const overlay = document.getElementById('overlay');
    const adminEmailSpan = document.getElementById('adminEmail');
    const avatarInitial = document.getElementById('avatarInitial');
    const logoutBtn = document.getElementById('logoutBtn');

    auth.onAuthStateChanged((user) => {
      if (!user || !user.email || !ALLOWED_ADMINS.includes(user.email)) {
        if (user) auth.signOut();
        window.location.href = 'index.html';
      } else {
        adminEmailSpan.textContent = user.email;
        avatarInitial.textContent = user.email.charAt(0).toUpperCase();
        overlay.style.display = 'none';
        // After auth ok, load data from backend
        bootstrapLoad();
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = 'index.html';
    });

    // ===== BACKEND STATE =====
    let courses = [];
    let tests = [];
    let updates = [];

    // ===== NAVIGATION =====
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');

    navLinks.forEach((link) => {
      link.addEventListener('click', () => {
        const target = link.getAttribute('data-section');
        navLinks.forEach((l) => l.classList.remove('active'));
        link.classList.add('active');

        sections.forEach((sec) => {
          if (sec.id === 'section-' + target) sec.classList.add('active');
          else sec.classList.remove('active');
        });
      });
    });

    // ===== COURSES =====
    const coursesTableBody = document.querySelector('#coursesTable tbody');
    const courseForm = document.getElementById('courseForm');
    const statCourses = document.getElementById('stat-courses');
    const courseTitleInput = document.getElementById('courseTitle');
    const courseLevelInput = document.getElementById('courseLevel');
    const courseTypeInput = document.getElementById('courseType');
    const coursePriceInput = document.getElementById('coursePrice');
    const courseSubtitleInput = document.getElementById('courseSubtitle');
    const courseSubmitBtn = document.getElementById('courseSubmitBtn');
    const courseCancelEditBtn = document.getElementById('courseCancelEditBtn');
    const addCourseScrollBtn = document.getElementById('addCourseScrollBtn');
    const courseSearchInput = document.getElementById('courseSearch');
    const courseFilterTypeSelect = document.getElementById('courseFilterType');

    let editingCourseId = null;
    let courseSearchTerm = '';
    let courseFilterType = 'all';

    async function fetchCourses() {
      const res = await fetch(`${API_BASE}/courses`);
      if (!res.ok) throw new Error("Failed to load courses");
      courses = await res.json();
    }

    function renderCourses() {
      coursesTableBody.innerHTML = '';

      const filtered = courses.filter((course) => {
        const term = courseSearchTerm;
        const matchesSearch =
          !term ||
          (course.title && course.title.toLowerCase().includes(term)) ||
          (course.subtitle && course.subtitle.toLowerCase().includes(term));

        const matchesType = courseFilterType === 'all' || course.type === courseFilterType;
        return matchesSearch && matchesType;
      });

      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" style="text-align:center;color:#9ca3af;font-size:12px;padding:16px;">
            No courses found. Try changing search/filter.
          </td>`;
        coursesTableBody.appendChild(tr);
      } else {
        filtered.forEach((course, index) => {
          const tr = document.createElement('tr');
          const isFree = course.type === 'free';
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>
              <strong>${escapeHtml(course.title)}</strong><br/>
              <span style="font-size:11px;color:#6b7280;">${escapeHtml(course.subtitle || '')}</span>
            </td>
            <td>${escapeHtml(course.level || '-')}</td>
            <td>
              <span class="badge ${isFree ? 'badge-free' : 'badge-paid'}">
                ${isFree ? 'Free' : 'Paid'}
              </span>
            </td>
            <td>‚Çπ${course.price || 0}</td>
            <td>
              <button class="btn-secondary" data-action="content" data-id="${course.id}">Content</button>
              <button class="btn-secondary" data-action="edit" data-id="${course.id}">Edit</button>
              <button class="btn-secondary" data-action="delete" data-id="${course.id}">Delete</button>
            </td>
          `;
          coursesTableBody.appendChild(tr);
        });
      }

      statCourses.textContent = courses.length.toString();
    }

    coursesTableBody.addEventListener('click', async (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!action || !id) return;

      const courseId = parseInt(id, 10);

      if (action === 'delete') {
        if (confirm('Delete this course?')) {
          await fetch(`${API_BASE}/courses/${courseId}`, { method: "DELETE" });
          if (editingCourseId === courseId) resetCourseForm();
          if (currentContentCourseId === courseId) hideCourseContentEditor();
          await fetchCourses();
          renderCourses();
        }
      } else if (action === 'edit') {
        const course = courses.find((c) => c.id === courseId);
        if (!course) return;
        editingCourseId = course.id;
        courseTitleInput.value = course.title || '';
        courseLevelInput.value = course.level || '';
        courseTypeInput.value = course.type || 'free';
        coursePriceInput.value = course.price || 0;
        courseSubtitleInput.value = course.subtitle || '';
        courseSubmitBtn.textContent = 'Update course';
        courseCancelEditBtn.style.display = 'inline-flex';
        courseTitleInput.focus();
        courseForm.scrollIntoView({ behavior: 'smooth' });
      } else if (action === 'content') {
        openCourseContentEditor(courseId);
      }
    });

    function resetCourseForm() {
      editingCourseId = null;
      courseForm.reset();
      courseSubmitBtn.textContent = 'Save course';
      courseCancelEditBtn.style.display = 'none';
    }

    courseCancelEditBtn.addEventListener('click', resetCourseForm);

    courseForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = courseTitleInput.value.trim();
      if (!title) return;

      const payload = {
        title,
        level: courseLevelInput.value.trim(),
        type: courseTypeInput.value,
        price: coursePriceInput.value ? Number(coursePriceInput.value) : 0,
        subtitle: courseSubtitleInput.value.trim(),
      };

      if (editingCourseId) {
        await fetch(`${API_BASE}/courses/${editingCourseId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } else {
        await fetch(`${API_BASE}/courses`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      resetCourseForm();
      await fetchCourses();
      renderCourses();
    });

    addCourseScrollBtn.addEventListener('click', () => {
      courseForm.scrollIntoView({ behavior: 'smooth' });
      courseTitleInput.focus();
    });

    courseSearchInput.addEventListener('input', (e) => {
      courseSearchTerm = e.target.value.toLowerCase();
      renderCourses();
    });

    courseFilterTypeSelect.addEventListener('change', (e) => {
      courseFilterType = e.target.value;
      renderCourses();
    });

    // ===== COURSE CONTENT EDITOR (LOCAL ONLY) =====
    const courseContentEditor = document.getElementById('courseContentEditor');
    const ccCourseTitleSpan = document.getElementById('ccCourseTitle');
    const ccSectionsContainer = document.getElementById('ccSectionsContainer');
    const ccAddSectionBtn = document.getElementById('ccAddSectionBtn');
    const ccJsonOutput = document.getElementById('ccJsonOutput');
    const ccShowJsonBtn = document.getElementById('ccShowJsonBtn');
    const ccCopyJsonBtn = document.getElementById('ccCopyJsonBtn');

    let courseContents = {};
    let currentContentCourseId = null;

    function hideCourseContentEditor() {
      currentContentCourseId = null;
      courseContentEditor.style.display = 'none';
      ccCourseTitleSpan.textContent = '';
      ccSectionsContainer.innerHTML = '';
      if (ccJsonOutput) {
        ccJsonOutput.value = '';
        ccJsonOutput.style.display = 'none';
        if (ccShowJsonBtn) ccShowJsonBtn.textContent = 'Show JSON';
      }
    }

    function openCourseContentEditor(courseId) {
      const course = courses.find((c) => c.id === courseId);
      if (!course) return;

      currentContentCourseId = courseId;
      ccCourseTitleSpan.textContent = course.title;

      if (!courseContents[courseId]) courseContents[courseId] = [];
      renderCourseContent();
      courseContentEditor.style.display = 'block';
      courseContentEditor.scrollIntoView({ behavior: 'smooth' });
    }

    function getCurrentCourseContentPayload() {
      if (!currentContentCourseId) return null;
      const course = courses.find((c) => c.id === currentContentCourseId);
      if (!course) return null;

      const sections = (courseContents[currentContentCourseId] || []).map((sec) => ({
        id: sec.id,
        title: sec.title,
        description: sec.description,
        lessons: (sec.lessons || []).map((lesson) => ({
          id: lesson.id,
          title: lesson.title,
          type: lesson.type,
          durationLabel: lesson.durationLabel,
          contentUrl: lesson.contentUrl,
          isLocked: !!lesson.isLocked
        }))
      }));

      return { courseId: course.id, courseTitle: course.title, sections };
    }

    function updateJsonPreview() {
      if (!ccJsonOutput) return;
      const payload = getCurrentCourseContentPayload();
      ccJsonOutput.value = payload ? JSON.stringify(payload, null, 2) : '';
    }

    function renderCourseContent() {
      if (!currentContentCourseId) return;
      const sections = courseContents[currentContentCourseId] || [];

      if (sections.length === 0) {
        ccSectionsContainer.innerHTML = `
          <p class="muted" style="margin-top:4px;">
            Abhi koi section nahi hai. "Add section" se naya section banao.
          </p>
        `;
        updateJsonPreview();
        return;
      }

      let html = '';
      sections.forEach((sec, index) => {
        html += `
          <div class="cc-section-card">
            <div class="cc-section-header">
              <div>
                <div class="cc-section-title">${index + 1}. ${escapeHtml(sec.title)}</div>
                ${sec.description ? `<div class="cc-section-desc">${escapeHtml(sec.description)}</div>` : ''}
              </div>
              <div class="cc-section-actions">
                <button class="btn-secondary" data-cc-action="add-lesson" data-sec-id="${sec.id}">+ Lesson</button>
                <button class="btn-secondary" data-cc-action="edit-section" data-sec-id="${sec.id}">Edit</button>
                <button class="btn-secondary" data-cc-action="delete-section" data-sec-id="${sec.id}">Delete</button>
              </div>
            </div>
            <div class="cc-lessons-wrapper">${renderLessonsTable(sec)}</div>
          </div>
        `;
      });

      ccSectionsContainer.innerHTML = html;
      updateJsonPreview();
    }

    function renderLessonsTable(sec) {
      const lessons = sec.lessons || [];
      if (lessons.length === 0) {
        return `<div class="muted">No lessons yet. "Add Lesson" se add karo.</div>`;
      }

      let rows = '';
      lessons.forEach((lesson, index) => {
        const lockClass = lesson.isLocked ? 'cc-tag-lock' : 'cc-tag-unlock';
        const lockText = lesson.isLocked ? 'Locked' : 'Free';
        rows += `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(lesson.title)}</td>
            <td>${escapeHtml(lesson.type)}</td>
            <td>${escapeHtml(lesson.durationLabel || '')}</td>
            <td><span class="${lockClass}">${lockText}</span></td>
            <td>
              <button class="btn-secondary" data-cc-action="edit-lesson" data-sec-id="${sec.id}" data-lesson-id="${lesson.id}">Edit</button>
              <button class="btn-secondary" data-cc-action="delete-lesson" data-sec-id="${sec.id}" data-lesson-id="${lesson.id}">Delete</button>
            </td>
          </tr>
        `;
      });

      return `
        <table class="cc-lessons-table">
          <thead>
            <tr>
              <th>#</th><th>Title</th><th>Type</th><th>Duration</th><th>Lock</th><th style="width:150px;">Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    ccAddSectionBtn.addEventListener('click', () => {
      if (!currentContentCourseId) { alert('Pehle kisi course ka "Content" click karo.'); return; }
      const title = prompt('Section title (e.g. "Kinematics")');
      if (!title) return;
      const description = prompt('Section description (optional):') || '';

      const sections = courseContents[currentContentCourseId] || [];
      const newId = (sections[sections.length - 1]?.id || 0) + 1;

      sections.push({ id: newId, title: title.trim(), description: description.trim(), lessons: [] });
      courseContents[currentContentCourseId] = sections;
      renderCourseContent();
    });

    ccSectionsContainer.addEventListener('click', (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;
      const action = btn.getAttribute('data-cc-action');
      if (!action) return;

      const secIdAttr = btn.getAttribute('data-sec-id');
      const lessonIdAttr = btn.getAttribute('data-lesson-id');
      const secId = secIdAttr ? parseInt(secIdAttr, 10) : null;
      const lessonId = lessonIdAttr ? parseInt(lessonIdAttr, 10) : null;

      const sections = courseContents[currentContentCourseId] || [];
      const secIndex = sections.findIndex((s) => s.id === secId);
      if (secIndex === -1 && secId !== null) return;
      const section = secId !== null ? sections[secIndex] : null;

      if (action === 'delete-section') {
        if (!section) return;
        if (confirm('Delete this section and all lessons?')) {
          sections.splice(secIndex, 1);
          courseContents[currentContentCourseId] = sections;
          renderCourseContent();
        }
      } else if (action === 'edit-section') {
        if (!section) return;
        const newTitle = prompt('Section title:', section.title) || section.title;
        const newDesc = prompt('Section description:', section.description || '') || '';
        section.title = newTitle.trim();
        section.description = newDesc.trim();
        renderCourseContent();
      } else if (action === 'add-lesson') {
        if (!section) return;
        addOrEditLesson(section, null);
      } else if (action === 'edit-lesson') {
        if (!section || lessonId == null) return;
        const lesson = section.lessons.find((l) => l.id === lessonId);
        if (!lesson) return;
        addOrEditLesson(section, lesson);
      } else if (action === 'delete-lesson') {
        if (!section || lessonId == null) return;
        if (confirm('Delete this lesson?')) {
          section.lessons = section.lessons.filter((l) => l.id !== lessonId);
          renderCourseContent();
        }
      }
    });

    function addOrEditLesson(section, existingLesson) {
      const prev = existingLesson || {};
      const title = prompt('Lesson title:', prev.title || '');
      if (!title) return;

      const typeRaw = prompt('Type (video/pdf/notes/quiz):', prev.type || 'video') || 'video';
      const type = typeRaw.trim().toLowerCase();
      if (!['video', 'pdf', 'notes', 'quiz'].includes(type)) {
        alert('Type must be: video, pdf, notes, quiz');
        return;
      }

      const durationLabel = prompt('Duration label (optional):', prev.durationLabel || '') || '';
      const contentUrl = prompt('Content URL (optional):', prev.contentUrl || '') || '';
      const lockAnswer = prompt('Locked for premium only? (yes/no):', prev.isLocked ? 'yes' : 'no') || 'no';
      const isLocked = lockAnswer.trim().toLowerCase().startsWith('y');

      if (existingLesson) {
        existingLesson.title = title.trim();
        existingLesson.type = type;
        existingLesson.durationLabel = durationLabel.trim();
        existingLesson.contentUrl = contentUrl.trim();
        existingLesson.isLocked = isLocked;
      } else {
        const lessons = section.lessons || [];
        const newLessonId = (lessons[lessons.length - 1]?.id || 0) + 1;
        lessons.push({ id: newLessonId, title: title.trim(), type, durationLabel: durationLabel.trim(), contentUrl: contentUrl.trim(), isLocked });
        section.lessons = lessons;
      }
      renderCourseContent();
    }

    if (ccShowJsonBtn) {
      ccShowJsonBtn.addEventListener('click', () => {
        if (!ccJsonOutput) return;
        const isHidden = ccJsonOutput.style.display === 'none' || ccJsonOutput.style.display === '';
        if (isHidden) { updateJsonPreview(); ccJsonOutput.style.display = 'block'; ccShowJsonBtn.textContent = 'Hide JSON'; }
        else { ccJsonOutput.style.display = 'none'; ccShowJsonBtn.textContent = 'Show JSON'; }
      });
    }
    if (ccCopyJsonBtn) {
      ccCopyJsonBtn.addEventListener('click', async () => {
        if (!ccJsonOutput.value) updateJsonPreview();
        try { await navigator.clipboard.writeText(ccJsonOutput.value || ''); alert('Course content JSON copied!'); }
        catch { alert('Copy failed. Manually copy JSON.'); }
      });
    }

    // ===== TESTS =====
    const testsTableBody = document.querySelector('#testsTable tbody');
    const testForm = document.getElementById('testForm');
    const statTests = document.getElementById('stat-tests');
    const testNameInput = document.getElementById('testName');
    const testCourseInput = document.getElementById('testCourse');
    const testQuestionsInput = document.getElementById('testQuestions');
    const testDurationInput = document.getElementById('testDuration');
    const testStatusInput = document.getElementById('testStatus');
    const testSubmitBtn = document.getElementById('testSubmitBtn');
    const testCancelEditBtn = document.getElementById('testCancelEditBtn');
    const addTestScrollBtn = document.getElementById('addTestScrollBtn');
    const testSearchInput = document.getElementById('testSearch');
    const testFilterStatusSelect = document.getElementById('testFilterStatus');

    let editingTestId = null;
    let testSearchTerm = '';
    let testFilterStatus = 'all';

    const testContentEditor = document.getElementById('testContentEditor');
    const tcTestTitleSpan = document.getElementById('tcTestTitle');
    const tcQuestionsContainer = document.getElementById('tcQuestionsContainer');
    const tcAddQuestionBtn = document.getElementById('tcAddQuestionBtn');

    let testsContents = {};
    let currentContentTestId = null;

    async function fetchTests() {
      const res = await fetch(`${API_BASE}/tests`);
      if (!res.ok) throw new Error("Failed to load tests");
      tests = await res.json();
    }

    function hideTestContentEditor() {
      currentContentTestId = null;
      testContentEditor.style.display = 'none';
      tcTestTitleSpan.textContent = '';
      tcQuestionsContainer.innerHTML = '';
    }

    function openTestContentEditor(testId) {
      const t = tests.find((x) => x.id === testId);
      if (!t) return;
      currentContentTestId = testId;
      tcTestTitleSpan.textContent = t.name;
      if (!testsContents[testId]) testsContents[testId] = [];
      renderTestContent();
      testContentEditor.style.display = 'block';
      testContentEditor.scrollIntoView({ behavior: 'smooth' });
    }

    function renderTestContent() {
      if (!currentContentTestId) return;
      const questions = testsContents[currentContentTestId] || [];
      if (questions.length === 0) {
        tcQuestionsContainer.innerHTML = `<p class="muted" style="margin-top:4px;">Abhi koi question nahi hai. "Add question" se MCQ add karo.</p>`;
        return;
      }

      let html = '';
      questions.forEach((q, index) => {
        const marksText = (q.marks ?? q.marks === 0) ? `Marks: ${q.marks}` : '';
        const negText = (q.negativeMarks ?? q.negativeMarks === 0) ? (q.negativeMarks ? ` | Negative: -${q.negativeMarks}` : ' | Negative: 0') : '';
        const metaLine = (marksText || negText) ? (marksText + negText) : '';

        let optionsRows = '';
        (q.options || []).forEach((opt) => {
          const badge = opt.isCorrect ? '<span class="cc-tag-unlock">Correct</span>' : '<span class="cc-tag-lock">Incorrect</span>';
          optionsRows += `<tr><td>${escapeHtml(opt.label)}</td><td>${escapeHtml(opt.text)}</td><td>${badge}</td></tr>`;
        });
        if (!optionsRows) optionsRows = `<tr><td colspan="3" style="font-size:11px;color:#9ca3af;padding:6px 8px;">No options added.</td></tr>`;

        html += `
          <div class="cc-section-card">
            <div class="cc-section-header">
              <div>
                <div class="cc-section-title">Q${index + 1}. ${escapeHtml(q.text)}</div>
                ${metaLine ? `<div class="cc-section-desc">${metaLine}</div>` : ''}
                ${q.explanation ? `<div class="cc-section-desc">Explanation: ${escapeHtml(q.explanation)}</div>` : ''}
              </div>
              <div class="cc-section-actions">
                <button class="btn-secondary" data-tc-action="edit-question" data-qid="${q.id}">Edit</button>
                <button class="btn-secondary" data-tc-action="delete-question" data-qid="${q.id}">Delete</button>
              </div>
            </div>
            <div class="cc-lessons-wrapper">
              <table class="cc-lessons-table">
                <thead>
                  <tr><th style="width:60px;">Option</th><th>Text</th><th style="width:90px;">Correct?</th></tr>
                </thead>
                <tbody>${optionsRows}</tbody>
              </table>
            </div>
          </div>
        `;
      });

      tcQuestionsContainer.innerHTML = html;
    }

    function addOrEditQuestion(existingQuestion) {
      if (!currentContentTestId) { alert('Pehle kisi test ka "Content" click karo.'); return; }
      const prev = existingQuestion || {};
      const questionsArr = testsContents[currentContentTestId] || [];

      const text = prompt('Question text:', prev.text || '');
      if (!text) return;

      const marksRaw = prompt('Marks (e.g. 4):', prev.marks != null ? String(prev.marks) : '1');
      const marks = marksRaw ? Number(marksRaw) : null;

      const negRaw = prompt('Negative marks (e.g. 1 or 0):', prev.negativeMarks != null ? String(prev.negativeMarks) : '0');
      const negativeMarks = (negRaw !== null && negRaw !== '') ? Number(negRaw) : null;

      const explanation = prompt('Explanation (optional):', prev.explanation || '') || '';

      let optionsCountRaw = prompt('Number of options (3‚Äì6):', prev.options ? String(prev.options.length) : '4');
      let optionsCount = optionsCountRaw ? Number(optionsCountRaw) : 4;
      if (isNaN(optionsCount) || optionsCount < 3 || optionsCount > 6) optionsCount = 4;

      const labels = ['A','B','C','D','E','F'];
      const options = [];
      for (let i = 0; i < optionsCount; i++) {
        const prevOpt = prev.options && prev.options[i] ? prev.options[i].text : '';
        const optText = prompt(`Option ${labels[i]} text:`, prevOpt || '');
        if (!optText) { alert('Option empty, cancel.'); return; }
        options.push({ id: i+1, label: labels[i], text: optText.trim(), isCorrect: false });
      }

      let correctRaw = prompt(`Correct option number (1-${optionsCount}):`, '1');
      let correctIndex = correctRaw ? Number(correctRaw) : 1;
      if (isNaN(correctIndex) || correctIndex < 1 || correctIndex > optionsCount) correctIndex = 1;
      options.forEach((opt, idx) => opt.isCorrect = idx === (correctIndex - 1));

      if (existingQuestion) {
        existingQuestion.text = text.trim();
        existingQuestion.marks = marks;
        existingQuestion.negativeMarks = negativeMarks;
        existingQuestion.explanation = explanation.trim();
        existingQuestion.options = options;
      } else {
        const newId = (questionsArr[questionsArr.length - 1]?.id || 0) + 1;
        questionsArr.push({ id: newId, text: text.trim(), marks, negativeMarks, explanation: explanation.trim(), options });
        testsContents[currentContentTestId] = questionsArr;
      }

      renderTestContent();
    }

    tcAddQuestionBtn.addEventListener('click', () => addOrEditQuestion(null));

    tcQuestionsContainer.addEventListener('click', (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;
      const action = btn.getAttribute('data-tc-action');
      if (!action) return;

      const qidAttr = btn.getAttribute('data-qid');
      const qid = qidAttr ? parseInt(qidAttr, 10) : null;
      const questionsArr = testsContents[currentContentTestId] || [];
      const qIndex = questionsArr.findIndex((q) => q.id === qid);
      if (qIndex === -1) return;
      const question = questionsArr[qIndex];

      if (action === 'edit-question') addOrEditQuestion(question);
      else if (action === 'delete-question') {
        if (confirm('Delete this question?')) {
          questionsArr.splice(qIndex, 1);
          testsContents[currentContentTestId] = questionsArr;
          renderTestContent();
        }
      }
    });

    function renderTests() {
      testsTableBody.innerHTML = '';

      const filtered = tests.filter((t) => {
        const term = testSearchTerm;
        const matchesSearch =
          !term ||
          (t.name && t.name.toLowerCase().includes(term)) ||
          (t.course && t.course.toLowerCase().includes(term));

        const matchesStatus = testFilterStatus === 'all' || t.status === testFilterStatus;
        return matchesSearch && matchesStatus;
      });

      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" style="text-align:center;color:#9ca3af;font-size:12px;padding:16px;">
            No tests found. Try changing search/filter.
          </td>`;
        testsTableBody.appendChild(tr);
      } else {
        filtered.forEach((t, index) => {
          const tr = document.createElement('tr');
          const badgeClass = t.status === 'free' ? 'badge-free' : 'badge-paid';
          const badgeText = t.status === 'free' ? 'Free' : 'Premium';

          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${escapeHtml(t.name)}</td>
            <td>${escapeHtml(t.course || '-')}</td>
            <td>${t.questions || '-'}</td>
            <td>${escapeHtml(t.duration || '-')}</td>
            <td><span class="badge ${badgeClass}">${badgeText}</span></td>
            <td>
              <button class="btn-secondary" data-action="content-test" data-id="${t.id}">Content</button>
              <button class="btn-secondary" data-action="edit-test" data-id="${t.id}">Edit</button>
              <button class="btn-secondary" data-action="delete-test" data-id="${t.id}">Delete</button>
            </td>
          `;
          testsTableBody.appendChild(tr);
        });
      }

      statTests.textContent = tests.length.toString();
    }

    testsTableBody.addEventListener('click', async (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!action || !id) return;
      const testId = parseInt(id, 10);

      if (action === 'delete-test') {
        if (confirm('Delete this test?')) {
          await fetch(`${API_BASE}/tests/${testId}`, { method: "DELETE" });
          if (editingTestId === testId) resetTestForm();
          if (currentContentTestId === testId) hideTestContentEditor();
          await fetchTests();
          renderTests();
        }
      } else if (action === 'edit-test') {
        const t = tests.find((x) => x.id === testId);
        if (!t) return;
        editingTestId = t.id;
        testNameInput.value = t.name || '';
        testCourseInput.value = t.course || '';
        testQuestionsInput.value = t.questions || '';
        testDurationInput.value = t.duration || '';
        testStatusInput.value = t.status || 'free';
        testSubmitBtn.textContent = 'Update test';
        testCancelEditBtn.style.display = 'inline-flex';
        testForm.scrollIntoView({ behavior: 'smooth' });
        testNameInput.focus();
      } else if (action === 'content-test') {
        openTestContentEditor(testId);
      }
    });

    function resetTestForm() {
      editingTestId = null;
      testForm.reset();
      testSubmitBtn.textContent = 'Save test';
      testCancelEditBtn.style.display = 'none';
    }

    testCancelEditBtn.addEventListener('click', resetTestForm);

    testForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = testNameInput.value.trim();
      if (!name) return;

      const payload = {
        name,
        course: testCourseInput.value.trim(),
        questions: testQuestionsInput.value ? Number(testQuestionsInput.value) : 0,
        duration: testDurationInput.value.trim(),
        status: testStatusInput.value
      };

      if (editingTestId) {
        await fetch(`${API_BASE}/tests/${editingTestId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } else {
        await fetch(`${API_BASE}/tests`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      resetTestForm();
      await fetchTests();
      renderTests();
    });

    addTestScrollBtn.addEventListener('click', () => {
      testForm.scrollIntoView({ behavior: 'smooth' });
      testNameInput.focus();
    });

    testSearchInput.addEventListener('input', (e) => {
      testSearchTerm = e.target.value.toLowerCase();
      renderTests();
    });

    testFilterStatusSelect.addEventListener('change', (e) => {
      testFilterStatus = e.target.value;
      renderTests();
    });

    // ===== UPDATES =====
    const updatesTableBody = document.querySelector('#updatesTable tbody');
    const updateForm = document.getElementById('updateForm');
    const statUpdates = document.getElementById('stat-updates');
    const updateTitleInput = document.getElementById('updateTitle');
    const updateAudienceInput = document.getElementById('updateAudience');
    const updateBodyInput = document.getElementById('updateBody');
    const updateSubmitBtn = document.getElementById('updateSubmitBtn');
    const updateCancelEditBtn = document.getElementById('updateCancelEditBtn');
    const addUpdateScrollBtn = document.getElementById('addUpdateScrollBtn');
    const updateSearchInput = document.getElementById('updateSearch');

    let editingUpdateId = null;
    let updateSearchTerm = '';

    async function fetchUpdates() {
      const res = await fetch(`${API_BASE}/updates`);
      if (!res.ok) throw new Error("Failed to load updates");
      updates = await res.json();
    }

    function renderUpdates() {
      updatesTableBody.innerHTML = '';

      const filtered = updates.filter((u) => {
        const term = updateSearchTerm;
        return (
          !term ||
          (u.title && u.title.toLowerCase().includes(term)) ||
          (u.body && u.body.toLowerCase().includes(term))
        );
      });

      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" style="text-align:center;color:#9ca3af;font-size:12px;padding:16px;">
            No updates found. Try changing search.
          </td>`;
        updatesTableBody.appendChild(tr);
      } else {
        filtered.forEach((u, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>
              <strong>${escapeHtml(u.title)}</strong><br/>
              <span style="font-size:11px;color:#6b7280;">${escapeHtml(u.body || '')}</span>
            </td>
            <td>${escapeHtml(u.audience || 'All')}</td>
            <td>${escapeHtml(u.created_at || '-')}</td>
            <td>
              <button class="btn-secondary" data-action="edit-update" data-id="${u.id}">Edit</button>
              <button class="btn-secondary" data-action="delete-update" data-id="${u.id}">Delete</button>
            </td>
          `;
          updatesTableBody.appendChild(tr);
        });
      }

      statUpdates.textContent = updates.length.toString();
    }

    updatesTableBody.addEventListener('click', async (e) => {
      const btn = e.target;
      if (!(btn instanceof HTMLElement)) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!action || !id) return;
      const updateId = parseInt(id, 10);

      if (action === 'delete-update') {
        if (confirm('Delete this update?')) {
          await fetch(`${API_BASE}/updates/${updateId}`, { method: "DELETE" });
          if (editingUpdateId === updateId) resetUpdateForm();
          await fetchUpdates();
          renderUpdates();
        }
      } else if (action === 'edit-update') {
        const u = updates.find((x) => x.id === updateId);
        if (!u) return;
        editingUpdateId = u.id;
        updateTitleInput.value = u.title || '';
        updateAudienceInput.value = u.audience || '';
        updateBodyInput.value = u.body || '';
        updateSubmitBtn.textContent = 'Update update';
        updateCancelEditBtn.style.display = 'inline-flex';
        updateForm.scrollIntoView({ behavior: 'smooth' });
        updateTitleInput.focus();
      }
    });

    function resetUpdateForm() {
      editingUpdateId = null;
      updateForm.reset();
      updateSubmitBtn.textContent = 'Save update';
      updateCancelEditBtn.style.display = 'none';
    }

    updateCancelEditBtn.addEventListener('click', resetUpdateForm);

    updateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = updateTitleInput.value.trim();
      if (!title) return;

      const payload = {
        title,
        audience: updateAudienceInput.value.trim(),
        body: updateBodyInput.value.trim(),
      };

      if (editingUpdateId) {
        await fetch(`${API_BASE}/updates/${editingUpdateId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } else {
        await fetch(`${API_BASE}/updates`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      resetUpdateForm();
      await fetchUpdates();
      renderUpdates();
    });

    addUpdateScrollBtn.addEventListener('click', () => {
      updateForm.scrollIntoView({ behavior: 'smooth' });
      updateTitleInput.focus();
    });

    updateSearchInput.addEventListener('input', (e) => {
      updateSearchTerm = e.target.value.toLowerCase();
      renderUpdates();
    });

    // ===== UTIL =====
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function bootstrapLoad() {
      try {
        await fetchCourses();
        await fetchTests();
        await fetchUpdates();
        renderCourses();
        renderTests();
        renderUpdates();
      } catch (err) {
        console.error(err);
        alert("Backend not reachable. Make sure backend is running on http://localhost:8080");
      }
    }
  </script>
</body>
</html>
