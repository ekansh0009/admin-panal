<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PAPI Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #e5e7eb;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; }
    .logo-circle {
      width: 34px; height: 34px; border-radius: 999px;
      background: #4c6fff; display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px;
    }
    .sidebar-title { font-weight: 700; font-size: 18px; }
    .sidebar-sub { font-size: 11px; color: #9ca3af; }
    .nav { list-style: none; margin-top: 12px; }
    .nav-item { margin-bottom: 4px; }
    .nav-link {
      width: 100%; border-radius: 10px; padding: 8px 10px;
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; font-size: 14px; color: #e5e7eb;
      border: none; background: transparent; text-align: left;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .nav-link span.icon { font-size: 16px; width: 18px; text-align: center; }
    .nav-link.active, .nav-link:hover { background: #111827; color: #ffffff; }
    .sidebar-footer { margin-top: auto; font-size: 12px; color: #6b7280; }

    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .topbar {
      height: 56px; background: #ffffff; border-bottom: 1px solid #e5e7eb;
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    }
    .topbar-title { font-weight: 600; font-size: 16px; }
    .topbar-right { display: flex; align-items: center; gap: 12px; font-size: 13px; color: #6b7280; }
    .avatar {
      width: 32px; height: 32px; border-radius: 999px; background: #4c6fff; color: #fff;
      display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600;
    }
    .logout-btn {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px;
      background: #ffffff; color: #374151; font-size: 12px; cursor: pointer;
    }

    .content { padding: 18px 20px 24px; min-height: calc(100vh - 56px); }
    .section { display: none; }
    .section.active { display: block; }
    .section-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; gap: 10px; flex-wrap: wrap;
    }
    .section-title { font-size: 20px; font-weight: 700; }
    .btn-primary {
      border-radius: 10px; border: none; padding: 8px 14px; background: #4c6fff; color: #ffffff;
      font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-secondary {
      border-radius: 8px; border: 1px solid #e5e7eb; padding: 6px 10px; background: #ffffff;
      color: #374151; font-size: 12px; cursor: pointer;
    }

    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; margin-bottom: 18px; }
    .card { background: #ffffff; border-radius: 14px; padding: 14px; border: 1px solid #e5e7eb; }
    .card-title { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
    .card-value { font-size: 18px; font-weight: 700; }
    .card-sub { font-size: 11px; color: #9ca3af; margin-top: 4px; }

    .section-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
    .toolbar-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .toolbar-input {
      border-radius: 999px; border: 1px solid #e5e7eb; padding: 7px 10px;
      font-size: 13px; background: #ffffff; min-width: 160px;
    }
    .toolbar-input::placeholder { color: #9ca3af; }

    table {
      width: 100%; border-collapse: collapse; font-size: 13px; background: #ffffff;
      border-radius: 14px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    thead { background: #f9fafb; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { font-size: 12px; font-weight: 600; color: #6b7280; }
    tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: #f9fafb; }

    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .badge-free { background: #e0f2fe; color: #0369a1; }
    .badge-paid { background: #fef3c7; color: #b45309; }
    .badge-status { background: #ecfdf5; color: #15803d; }

    .muted { font-size: 12px; color: #9ca3af; margin-top: 8px; }

    .inline-form {
      margin-top: 14px; background: #ffffff; border-radius: 14px; border: 1px solid #e5e7eb;
      padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .inline-input { flex: 1 1 180px; min-width: 0; }
    .inline-input input, .inline-input select, .inline-input textarea {
      width: 100%; border-radius: 8px; border: 1px solid #e5e7eb; padding: 7px 9px; font-size: 13px; resize: vertical;
    }

    #overlay {
      position: fixed; inset: 0; background: rgba(243, 244, 246, 0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; font-size: 14px; color: #6b7280;
    }

    #courseContentEditor { margin-top: 16px; }
    .cc-editor-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .cc-editor-subtitle { font-size: 12px; color: #6b7280; }
    .cc-sections-container { display: flex; flex-direction: column; gap: 10px; margin-top: 4px; }
    .cc-section-card { border-radius: 12px; border: 1px solid #e5e7eb; padding: 10px 12px; background: #f9fafb; }
    .cc-section-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
    .cc-section-title { font-size: 14px; font-weight: 600; }
    .cc-section-desc { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .cc-section-actions { display: flex; flex-wrap: wrap; gap: 6px; }
    .cc-lessons-wrapper { margin-top: 6px; }

    .cc-lessons-table {
      width: 100%; border-collapse: collapse; font-size: 12px; background: #ffffff;
      border-radius: 10px; overflow: hidden; border: 1px solid #e5e7eb;
    }
    .cc-lessons-table th, .cc-lessons-table td { padding: 6px 8px; border-bottom: 1px solid #e5e7eb; }
    .cc-lessons-table th { background: #f3f4f6; font-weight: 600; color: #6b7280; }
    .cc-lessons-table tr:last-child td { border-bottom: none; }

    .cc-tag-lock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #fee2e2; color: #b91c1c;
    }
    .cc-tag-unlock {
      display: inline-flex; align-items: center; padding: 2px 6px;
      border-radius: 999px; font-size: 10px; background: #dcfce7; color: #15803d;
    }

    .cc-json-toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
    .cc-json-output {
      margin-top: 4px; width: 100%; min-height: 140px; max-height: 260px;
      border-radius: 10px; border: 1px solid #e5e7eb; padding: 8px 10px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #f9fafb; resize: vertical; white-space: pre; overflow: auto;
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      body { flex-direction: column; }
      .main { width: 100%; }
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .inline-form { flex-direction: column; align-items: stretch; }
      .section-toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-input { width: 100%; }
      .cc-section-header { flex-direction: column; align-items: flex-start; }
      .cc-section-actions { width: 100%; }
    }
  </style>
</head>

<body>
  <div id="overlay">Checking admin access‚Ä¶</div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle">P</div>
      <div>
        <div class="sidebar-title">PAPI Admin</div>
        <div class="sidebar-sub">Control panel</div>
      </div>
    </div>

    <ul class="nav">
      <li class="nav-item"><button class="nav-link active" data-section="overview"><span class="icon">üè†</span> Dashboard</button></li>
      <li class="nav-item"><button class="nav-link" data-section="courses"><span class="icon">üìö</span> Courses</button></li>
      <li class="nav-item"><button class="nav-link" data-section="tests"><span class="icon">üìù</span> Tests</button></li>
      <li class="nav-item"><button class="nav-link" data-section="updates"><span class="icon">üì¢</span> Updates</button></li>
      <li class="nav-item"><button class="nav-link" data-section="settings"><span class="icon">‚öôÔ∏è</span> Settings</button></li>
    </ul>

    <div class="sidebar-footer">
      ¬© PAPI ‚Ä¢ v0.3<br />
      (Connected to local backend)
    </div>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-title">PAPI Admin Panel</div>
      <div class="topbar-right">
        <span id="adminEmail">Admin</span>
        <div class="avatar" id="avatarInitial">A</div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </header>

    <main class="content">
      <section class="section active" id="section-overview">
        <div class="section-header"><h2 class="section-title">Overview</h2></div>
        <div class="grid">
          <div class="card"><div class="card-title">Total Courses</div><div class="card-value" id="stat-courses">0</div><div class="card-sub">Free + paid</div></div>
          <div class="card"><div class="card-title">Total Tests</div><div class="card-value" id="stat-tests">0</div><div class="card-sub">Active test series</div></div>
          <div class="card"><div class="card-title">Total Updates</div><div class="card-value" id="stat-updates">0</div><div class="card-sub">Announcements</div></div>
        </div>
        <p class="muted">Now stats are coming from backend DB (SQLite). Refresh will keep the data.</p>
      </section>

      <!-- COURSES -->
      <section class="section" id="section-courses">
        <div class="section-header">
          <h2 class="section-title">Courses</h2>
          <button class="btn-primary" id="addCourseScrollBtn">+ Add new course</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="courseSearch" class="toolbar-input" placeholder="Search courses..." />
            <select id="courseFilterType" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
        </div>

        <table id="coursesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Level</th>
              <th>Type</th>
              <th>Price</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="courseForm">
          <div class="inline-input"><input type="text" id="courseTitle" placeholder="Course title" required /></div>
          <div class="inline-input"><input type="text" id="courseLevel" placeholder="Level (e.g. Class 11 / JEE)" /></div>
          <div class="inline-input">
            <select id="courseType">
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="inline-input"><input type="number" id="coursePrice" placeholder="Price (‚Çπ)" min="0" /></div>
          <div class="inline-input"><input type="text" id="courseSubtitle" placeholder="Subtitle (short tagline)" /></div>
          <button type="submit" class="btn-primary" id="courseSubmitBtn">Save course</button>
          <button type="button" class="btn-secondary" id="courseCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Course Content Editor (local only for now) -->
        <div class="card" id="courseContentEditor" style="display:none;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Course content</div>
              <div class="cc-editor-subtitle">Manage sections & lessons for: <strong id="ccCourseTitle"></strong></div>
            </div>
            <button class="btn-primary" id="ccAddSectionBtn">+ Add section</button>
          </div>

          <div class="cc-json-toolbar">
            <button class="btn-secondary" id="ccShowJsonBtn">Show JSON</button>
            <button class="btn-secondary" id="ccCopyJsonBtn">Copy JSON</button>
          </div>
          <textarea id="ccJsonOutput" class="cc-json-output" readonly style="display:none;"></textarea>

          <div class="cc-sections-container" id="ccSectionsContainer"></div>
          <p class="muted">
            Note: content editor is local for now. Backend endpoints will be added later to save this JSON.
          </p>
        </div>

        <p class="muted">Courses are now saved in SQLite via API.</p>
      </section>

      <!-- TESTS -->
      <section class="section" id="section-tests">
        <div class="section-header">
          <h2 class="section-title">Tests</h2>
          <button class="btn-primary" id="addTestScrollBtn">+ Add new test</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="testSearch" class="toolbar-input" placeholder="Search tests..." />
            <select id="testFilterStatus" class="toolbar-input">
              <option value="all">All types</option>
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
        </div>

        <table id="testsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Test Name</th>
              <th>Course</th>
              <th>Questions</th>
              <th>Duration</th>
              <th>Status</th>
              <th style="width: 200px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="testForm">
          <div class="inline-input"><input type="text" id="testName" placeholder="Test title" required /></div>
          <div class="inline-input"><input type="text" id="testCourse" placeholder="Belongs to course" /></div>
          <div class="inline-input"><input type="number" id="testQuestions" placeholder="Questions" min="1" /></div>
          <div class="inline-input"><input type="text" id="testDuration" placeholder="Duration (e.g. 60 min)" /></div>
          <div class="inline-input">
            <select id="testStatus">
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <button type="submit" class="btn-primary" id="testSubmitBtn">Save test</button>
          <button type="button" class="btn-secondary" id="testCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <!-- Test content editor (local only) -->
        <div class="card" id="testContentEditor" style="display:none; margin-top:16px;">
          <div class="cc-editor-header">
            <div>
              <div class="card-title">Test content</div>
              <div class="cc-editor-subtitle">Manage questions for: <strong id="tcTestTitle"></strong></div>
            </div>
            <button class="btn-primary" id="tcAddQuestionBtn">+ Add question</button>
          </div>
          <div class="cc-sections-container" id="tcQuestionsContainer"></div>
          <p class="muted">Note: questions editor is local for now. Backend endpoints will be added later.</p>
        </div>

        <p class="muted">Tests are now saved in SQLite via API.</p>
      </section>

      <!-- UPDATES -->
      <section class="section" id="section-updates">
        <div class="section-header">
          <h2 class="section-title">Updates</h2>
          <button class="btn-primary" id="addUpdateScrollBtn">+ Add new update</button>
        </div>

        <div class="section-toolbar">
          <div class="toolbar-group">
            <input type="text" id="updateSearch" class="toolbar-input" placeholder="Search updates..." />
          </div>
        </div>

        <table id="updatesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Visible to</th>
              <th>Created at</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <form class="inline-form" id="updateForm">
          <div class="inline-input"><input type="text" id="updateTitle" placeholder="Update title" required /></div>
          <div class="inline-input"><input type="text" id="updateAudience" placeholder="Visible to (e.g. All / JEE / NEET)" /></div>
          <div class="inline-input"><textarea id="updateBody" rows="2" placeholder="Short description"></textarea></div>
          <button type="submit" class="btn-primary" id="updateSubmitBtn">Save update</button>
          <button type="button" class="btn-secondary" id="updateCancelEditBtn" style="display:none;">Cancel edit</button>
        </form>

        <p class="muted">Updates are now saved in SQLite via API.</p>
      </section>

      <section class="section" id="section-settings">
        <div class="section-header"><h2 class="section-title">Settings</h2></div>
        <div class="card">
          <div class="card-title">Admin Settings (placeholder)</div>
          <p class="muted">Future: admin users, app config, ads config, etc.</p>
        </div>
      </section>
    </main>
  </div>

<script>
const API_BASE = "http://localhost:8080/api";

/* ========= FIREBASE ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBnDo5VJiM2noDWRWk281aVaUfPZ-sX08A",
  authDomain: "papi0009.firebaseapp.com",
  projectId: "papi0009",
  storageBucket: "papi0009.firebasestorage.app",
  messagingSenderId: "598318485319",
  appId: "1:598318485319:web:b26e84907d49a92d42c662",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const ALLOWED_ADMINS = ["admin@papi.in"];

const overlay = document.getElementById("overlay");
const logoutBtn = document.getElementById("logoutBtn");
const adminEmailEl = document.getElementById("adminEmail");
const avatarInitialEl = document.getElementById("avatarInitial");

/* ========= HELPERS ========= */
function uid(prefix="id") {
  return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
}

async function api(path, options = {}) {
  const res = await fetch(`${API_BASE}${path}`, {
    headers: { "Content-Type": "application/json", ...(options.headers || {}) },
    ...options,
  });

  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch (_) {}

  if (!res.ok) {
    const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

/* ========= NAV ========= */
function setActiveSection(key) {
  document.querySelectorAll(".nav-link").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.section === key);
  });
  document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
  const target = document.getElementById(`section-${key}`);
  if (target) target.classList.add("active");
}

function initNav() {
  document.querySelectorAll(".nav-link").forEach(btn => {
    btn.addEventListener("click", () => setActiveSection(btn.dataset.section));
  });
}

/* ========= GLOBAL STATE ========= */
let courses = [];
let tests = [];
let updates = [];

let currentContentCourseId = null;
let currentContentTestId = null;

let editingCourseId = null;
let editingTestId = null;
let editingUpdateId = null;

/* ====== CONTENT STATE (UI Editors) ====== */
const ccState = { modules: [] }; // Course content: modules -> items
const tcState = { questions: [] }; // Test content: questions array

/* ========= LOAD DATA ========= */
async function fetchCourses() { courses = await api("/courses"); }
async function fetchTests() { tests = await api("/tests"); }
async function fetchUpdates() { updates = await api("/updates"); }

function renderStats() {
  document.getElementById("stat-courses").textContent = courses.length;
  document.getElementById("stat-tests").textContent = tests.length;
  document.getElementById("stat-updates").textContent = updates.length;
}

/* ========= COURSES TABLE ========= */
async function renderCourses() {
  await fetchCourses();
  const tbody = document.querySelector("#coursesTable tbody");
  tbody.innerHTML = "";

  courses.forEach((c, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${c.title}</td>
      <td>${c.level || "-"}</td>
      <td>${c.type || "free"}</td>
      <td>‚Çπ${c.price || 0}</td>
      <td>
        <button class="btn-secondary" onclick="openCourseContentEditor(${c.id})">Content</button>
        <button class="btn-secondary" onclick="startEditCourse(${c.id})">Edit</button>
        <button class="btn-secondary" onclick="deleteCourse(${c.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ========= TESTS TABLE ========= */
async function renderTests() {
  await fetchTests();
  const tbody = document.querySelector("#testsTable tbody");
  tbody.innerHTML = "";

  tests.forEach((t, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${t.name}</td>
      <td>${t.course || "-"}</td>
      <td>${t.questions ?? "-"}</td>
      <td>${t.duration || "-"}</td>
      <td>${t.status || "free"}</td>
      <td>
        <button class="btn-secondary" onclick="openTestContentEditor(${t.id})">Content</button>
        <button class="btn-secondary" onclick="startEditTest(${t.id})">Edit</button>
        <button class="btn-secondary" onclick="deleteTest(${t.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ========= UPDATES TABLE ========= */
async function renderUpdates() {
  await fetchUpdates();
  const tbody = document.querySelector("#updatesTable tbody");
  tbody.innerHTML = "";

  updates.forEach((u, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${u.title}</td>
      <td>${u.audience || "All"}</td>
      <td>${u.created_at || "-"}</td>
      <td>
        <button class="btn-secondary" onclick="startEditUpdate(${u.id})">Edit</button>
        <button class="btn-secondary" onclick="deleteUpdate(${u.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   CRUD FORMS
========================= */

/* --- Courses form --- */
document.getElementById("courseForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    title: document.getElementById("courseTitle").value.trim(),
    level: document.getElementById("courseLevel").value.trim(),
    type: document.getElementById("courseType").value,
    price: Number(document.getElementById("coursePrice").value || 0),
    subtitle: document.getElementById("courseSubtitle").value.trim(),
  };

  try {
    if (!payload.title) return alert("Course title required");

    if (editingCourseId) {
      await api(`/courses/${editingCourseId}`, { method: "PUT", body: JSON.stringify(payload) });
      editingCourseId = null;
      document.getElementById("courseCancelEditBtn").style.display = "none";
    } else {
      await api("/courses", { method: "POST", body: JSON.stringify(payload) });
    }

    e.target.reset();
    await renderCourses();
    renderStats();
    alert("Saved ‚úÖ");
  } catch (err) {
    alert("Course save failed: " + err.message);
  }
});

function startEditCourse(id) {
  const c = courses.find(x => x.id === id);
  if (!c) return;

  editingCourseId = id;
  document.getElementById("courseTitle").value = c.title || "";
  document.getElementById("courseLevel").value = c.level || "";
  document.getElementById("courseType").value = c.type || "free";
  document.getElementById("coursePrice").value = c.price || 0;
  document.getElementById("courseSubtitle").value = c.subtitle || "";
  document.getElementById("courseCancelEditBtn").style.display = "inline-flex";
  setActiveSection("courses");
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

document.getElementById("courseCancelEditBtn").addEventListener("click", () => {
  editingCourseId = null;
  document.getElementById("courseForm").reset();
  document.getElementById("courseCancelEditBtn").style.display = "none";
});

async function deleteCourse(id) {
  if (!confirm("Delete this course?")) return;
  try {
    await api(`/courses/${id}`, { method: "DELETE" });
    await renderCourses();
    renderStats();
  } catch (err) {
    alert("Delete failed: " + err.message);
  }
}

/* --- Tests form --- */
document.getElementById("testForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    name: document.getElementById("testName").value.trim(),
    course: document.getElementById("testCourse").value.trim(),
    questions: Number(document.getElementById("testQuestions").value || 0),
    duration: document.getElementById("testDuration").value.trim(),
    status: document.getElementById("testStatus").value,
  };

  try {
    if (!payload.name) return alert("Test title required");

    if (editingTestId) {
      await api(`/tests/${editingTestId}`, { method: "PUT", body: JSON.stringify(payload) });
      editingTestId = null;
      document.getElementById("testCancelEditBtn").style.display = "none";
    } else {
      await api("/tests", { method: "POST", body: JSON.stringify(payload) });
    }

    e.target.reset();
    await renderTests();
    renderStats();
    alert("Saved ‚úÖ");
  } catch (err) {
    alert("Test save failed: " + err.message);
  }
});

function startEditTest(id) {
  const t = tests.find(x => x.id === id);
  if (!t) return;

  editingTestId = id;
  document.getElementById("testName").value = t.name || "";
  document.getElementById("testCourse").value = t.course || "";
  document.getElementById("testQuestions").value = t.questions || 0;
  document.getElementById("testDuration").value = t.duration || "";
  document.getElementById("testStatus").value = t.status || "free";
  document.getElementById("testCancelEditBtn").style.display = "inline-flex";
  setActiveSection("tests");
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

document.getElementById("testCancelEditBtn").addEventListener("click", () => {
  editingTestId = null;
  document.getElementById("testForm").reset();
  document.getElementById("testCancelEditBtn").style.display = "none";
});

async function deleteTest(id) {
  if (!confirm("Delete this test?")) return;
  try {
    await api(`/tests/${id}`, { method: "DELETE" });
    await renderTests();
    renderStats();
  } catch (err) {
    alert("Delete failed: " + err.message);
  }
}

/* --- Updates form --- */
document.getElementById("updateForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    title: document.getElementById("updateTitle").value.trim(),
    audience: document.getElementById("updateAudience").value.trim(),
    body: document.getElementById("updateBody").value.trim(),
  };

  try {
    if (!payload.title) return alert("Update title required");

    if (editingUpdateId) {
      await api(`/updates/${editingUpdateId}`, { method: "PUT", body: JSON.stringify(payload) });
      editingUpdateId = null;
      document.getElementById("updateCancelEditBtn").style.display = "none";
    } else {
      await api("/updates", { method: "POST", body: JSON.stringify(payload) });
    }

    e.target.reset();
    await renderUpdates();
    renderStats();
    alert("Saved ‚úÖ");
  } catch (err) {
    alert("Update save failed: " + err.message);
  }
});

function startEditUpdate(id) {
  const u = updates.find(x => x.id === id);
  if (!u) return;

  editingUpdateId = id;
  document.getElementById("updateTitle").value = u.title || "";
  document.getElementById("updateAudience").value = u.audience || "";
  document.getElementById("updateBody").value = u.body || "";
  document.getElementById("updateCancelEditBtn").style.display = "inline-flex";
  setActiveSection("updates");
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}

document.getElementById("updateCancelEditBtn").addEventListener("click", () => {
  editingUpdateId = null;
  document.getElementById("updateForm").reset();
  document.getElementById("updateCancelEditBtn").style.display = "none";
});

async function deleteUpdate(id) {
  if (!confirm("Delete this update?")) return;
  try {
    await api(`/updates/${id}`, { method: "DELETE" });
    await renderUpdates();
    renderStats();
  } catch (err) {
    alert("Delete failed: " + err.message);
  }
}

/* =========================
   COURSE CONTENT EDITOR (UI)
========================= */

const courseContentEditorEl = document.getElementById("courseContentEditor");
const ccCourseTitleEl = document.getElementById("ccCourseTitle");
const ccSectionsContainer = document.getElementById("ccSectionsContainer");
const ccJsonOutput = document.getElementById("ccJsonOutput");

const ccAddSectionBtn = document.getElementById("ccAddSectionBtn");
const ccShowJsonBtn = document.getElementById("ccShowJsonBtn");
const ccCopyJsonBtn = document.getElementById("ccCopyJsonBtn");
const ccSaveBtn = document.getElementById("ccSaveBtn");

function normalizeCourseContent(data) {
  // Accept {modules:[]}, {sections:[]}, or [] directly
  if (Array.isArray(data)) return { modules: data };
  if (data && Array.isArray(data.modules)) return { modules: data.modules };
  if (data && Array.isArray(data.sections)) {
    // legacy sections -> modules mapping (best-effort)
    const modules = data.sections.map((s, idx) => ({
      id: s.id || uid("mod"),
      title: s.title || `Section ${idx+1}`,
      description: s.description || "",
      order: Number(s.order ?? idx),
      items: Array.isArray(s.items) ? s.items : (Array.isArray(s.lessons) ? s.lessons : []),
    }));
    return { modules };
  }
  return { modules: [] };
}

function renderCourseContentEditor() {
  ccSectionsContainer.innerHTML = "";

  ccState.modules
    .sort((a,b) => (a.order ?? 0) - (b.order ?? 0))
    .forEach((mod, modIndex) => {
      if (!mod.id) mod.id = uid("mod");
      if (!Array.isArray(mod.items)) mod.items = [];

      const card = document.createElement("div");
      card.className = "cc-section-card";

      card.innerHTML = `
        <div class="cc-section-header">
          <div style="flex:1; min-width:260px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <input
                style="flex:1; min-width:200px; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
                placeholder="Section title"
                value="${(mod.title || "").replaceAll('"','&quot;')}"
                data-cc="mod-title"
                data-mod="${modIndex}"
              />
              <input
                style="width:90px; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
                type="number"
                placeholder="Order"
                value="${mod.order ?? modIndex}"
                data-cc="mod-order"
                data-mod="${modIndex}"
              />
            </div>
            <div style="margin-top:8px;">
              <textarea
                style="width:100%; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
                rows="2"
                placeholder="Section description (optional)"
                data-cc="mod-desc"
                data-mod="${modIndex}"
              >${mod.description || ""}</textarea>
            </div>
          </div>

          <div class="cc-section-actions">
            <button class="btn-secondary" data-cc="mod-up" data-mod="${modIndex}">‚Üë</button>
            <button class="btn-secondary" data-cc="mod-down" data-mod="${modIndex}">‚Üì</button>
            <button class="btn-secondary" data-cc="add-item" data-mod="${modIndex}">+ Lesson</button>
            <button class="btn-secondary" data-cc="delete-mod" data-mod="${modIndex}">Delete</button>
          </div>
        </div>

        <div class="cc-lessons-wrapper">
          <table class="cc-lessons-table">
            <thead>
              <tr>
                <th style="width:30px;">#</th>
                <th>Title</th>
                <th style="width:90px;">Type</th>
                <th style="width:90px;">Duration</th>
                <th style="width:90px;">Lock</th>
                <th style="width:90px;">Preview</th>
                <th style="width:260px;">Link / URL</th>
                <th style="width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody data-cc="items-body" data-mod="${modIndex}"></tbody>
          </table>
        </div>
      `;

      ccSectionsContainer.appendChild(card);

      const tbody = card.querySelector('tbody[data-cc="items-body"]');

      mod.items.forEach((it, itemIndex) => {
        if (!it.id) it.id = uid("item");
        if (!it.type) it.type = "video";

        const linkValue = it.video_url || it.pdf_url || it.external_link || it.quiz_id || "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${itemIndex + 1}</td>
          <td>
            <input
              style="width:100%; border-radius:8px; border:1px solid #e5e7eb; padding:6px 8px; font-size:12px;"
              placeholder="Lesson title"
              value="${(it.title || "").replaceAll('"','&quot;')}"
              data-cc="item-title"
              data-mod="${modIndex}"
              data-item="${itemIndex}"
            />
            <textarea
              style="width:100%; margin-top:6px; border-radius:8px; border:1px solid #e5e7eb; padding:6px 8px; font-size:12px;"
              rows="2"
              placeholder="Description (optional)"
              data-cc="item-desc"
              data-mod="${modIndex}"
              data-item="${itemIndex}"
            >${it.description || ""}</textarea>
          </td>
          <td>
            <select
              style="width:100%; border-radius:8px; border:1px solid #e5e7eb; padding:6px 8px; font-size:12px;"
              data-cc="item-type"
              data-mod="${modIndex}"
              data-item="${itemIndex}"
            >
              <option value="video" ${it.type==="video" ? "selected" : ""}>video</option>
              <option value="pdf" ${it.type==="pdf" ? "selected" : ""}>pdf</option>
              <option value="note" ${it.type==="note" ? "selected" : ""}>note</option>
              <option value="quiz" ${it.type==="quiz" ? "selected" : ""}>quiz</option>
              <option value="link" ${it.type==="link" ? "selected" : ""}>link</option>
            </select>
          </td>
          <td>
            <input
              type="number"
              style="width:100%; border-radius:8px; border:1px solid #e5e7eb; padding:6px 8px; font-size:12px;"
              placeholder="min"
              value="${it.duration_minutes ?? ""}"
              data-cc="item-duration"
              data-mod="${modIndex}"
              data-item="${itemIndex}"
            />
          </td>
          <td>
            <label style="display:flex; gap:6px; align-items:center; font-size:12px;">
              <input type="checkbox" ${it.is_locked ? "checked":""}
                data-cc="item-locked" data-mod="${modIndex}" data-item="${itemIndex}" />
              ${it.is_locked ? `<span class="cc-tag-lock">Locked</span>` : `<span class="cc-tag-unlock">Open</span>`}
            </label>
          </td>
          <td>
            <label style="display:flex; gap:6px; align-items:center; font-size:12px;">
              <input type="checkbox" ${it.is_preview ? "checked":""}
                data-cc="item-preview" data-mod="${modIndex}" data-item="${itemIndex}" />
              Preview
            </label>
          </td>
          <td>
            <input
              style="width:100%; border-radius:8px; border:1px solid #e5e7eb; padding:6px 8px; font-size:12px;"
              placeholder="video/pdf/link/quiz id"
              value="${(linkValue || "").replaceAll('"','&quot;')}"
              data-cc="item-link"
              data-mod="${modIndex}"
              data-item="${itemIndex}"
            />
            <div style="margin-top:4px; font-size:11px; color:#6b7280;">
              video_url / pdf_url / external_link / quiz_id (type ke hisaab se)
            </div>
          </td>
          <td>
            <button class="btn-secondary" data-cc="item-up" data-mod="${modIndex}" data-item="${itemIndex}">‚Üë</button>
            <button class="btn-secondary" data-cc="item-down" data-mod="${modIndex}" data-item="${itemIndex}">‚Üì</button>
            <button class="btn-secondary" data-cc="delete-item" data-mod="${modIndex}" data-item="${itemIndex}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
  });

  // update JSON box if visible
  if (ccJsonOutput.style.display !== "none") {
    ccJsonOutput.value = JSON.stringify({ modules: ccState.modules }, null, 2);
  }
}

function wireCourseContentEvents() {
  // input updates (delegation)
  courseContentEditorEl.addEventListener("input", (e) => {
    const t = e.target;
    if (!t.dataset || !t.dataset.cc) return;

    const cc = t.dataset.cc;
    const modIndex = Number(t.dataset.mod);
    const itemIndex = t.dataset.item !== undefined ? Number(t.dataset.item) : null;

    if (Number.isNaN(modIndex)) return;

    const mod = ccState.modules[modIndex];
    if (!mod) return;

    if (cc === "mod-title") mod.title = t.value;
    if (cc === "mod-desc") mod.description = t.value;
    if (cc === "mod-order") mod.order = Number(t.value || 0);

    if (itemIndex !== null) {
      const it = mod.items[itemIndex];
      if (!it) return;

      if (cc === "item-title") it.title = t.value;
      if (cc === "item-desc") it.description = t.value;
      if (cc === "item-type") {
        it.type = t.value;

        // clear link fields so mapping is clean
        it.video_url = null; it.pdf_url = null; it.external_link = null; it.quiz_id = null;
      }
      if (cc === "item-duration") it.duration_minutes = t.value ? Number(t.value) : null;
      if (cc === "item-link") {
        const val = t.value.trim();
        // map based on type
        it.video_url = null; it.pdf_url = null; it.external_link = null; it.quiz_id = null;
        if (!val) return;

        if (it.type === "video") it.video_url = val;
        else if (it.type === "pdf") it.pdf_url = val;
        else if (it.type === "link") it.external_link = val;
        else if (it.type === "quiz") it.quiz_id = val;
        else it.external_link = val;
      }
    }
  });

  courseContentEditorEl.addEventListener("change", (e) => {
    const t = e.target;
    if (!t.dataset || !t.dataset.cc) return;

    const cc = t.dataset.cc;
    const modIndex = Number(t.dataset.mod);
    const itemIndex = t.dataset.item !== undefined ? Number(t.dataset.item) : null;
    const mod = ccState.modules[modIndex];
    if (!mod) return;

    if (itemIndex !== null) {
      const it = mod.items[itemIndex];
      if (!it) return;

      if (cc === "item-locked") it.is_locked = !!t.checked;
      if (cc === "item-preview") it.is_preview = !!t.checked;

      // refresh to update lock badges
      renderCourseContentEditor();
    }
  });

  courseContentEditorEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn || !btn.dataset || !btn.dataset.cc) return;

    const cc = btn.dataset.cc;
    const modIndex = Number(btn.dataset.mod);
    const itemIndex = btn.dataset.item !== undefined ? Number(btn.dataset.item) : null;

    if (cc === "delete-mod") {
      if (!confirm("Delete this section?")) return;
      ccState.modules.splice(modIndex, 1);
      renderCourseContentEditor();
      return;
    }

    if (cc === "mod-up" && modIndex > 0) {
      const tmp = ccState.modules[modIndex - 1];
      ccState.modules[modIndex - 1] = ccState.modules[modIndex];
      ccState.modules[modIndex] = tmp;
      renderCourseContentEditor();
      return;
    }

    if (cc === "mod-down" && modIndex < ccState.modules.length - 1) {
      const tmp = ccState.modules[modIndex + 1];
      ccState.modules[modIndex + 1] = ccState.modules[modIndex];
      ccState.modules[modIndex] = tmp;
      renderCourseContentEditor();
      return;
    }

    if (cc === "add-item") {
      const mod = ccState.modules[modIndex];
      if (!mod.items) mod.items = [];
      mod.items.push({
        id: uid("item"),
        type: "video",
        title: "New lesson",
        description: "",
        duration_minutes: null,
        is_locked: false,
        is_preview: false,
        video_url: "",
        pdf_url: null,
        external_link: null,
        quiz_id: null,
      });
      renderCourseContentEditor();
      return;
    }

    if (cc === "delete-item" && itemIndex !== null) {
      if (!confirm("Delete this lesson?")) return;
      ccState.modules[modIndex].items.splice(itemIndex, 1);
      renderCourseContentEditor();
      return;
    }

    if (cc === "item-up" && itemIndex !== null && itemIndex > 0) {
      const items = ccState.modules[modIndex].items;
      [items[itemIndex - 1], items[itemIndex]] = [items[itemIndex], items[itemIndex - 1]];
      renderCourseContentEditor();
      return;
    }

    if (cc === "item-down" && itemIndex !== null) {
      const items = ccState.modules[modIndex].items;
      if (itemIndex < items.length - 1) {
        [items[itemIndex + 1], items[itemIndex]] = [items[itemIndex], items[itemIndex + 1]];
        renderCourseContentEditor();
      }
      return;
    }
  });

  ccAddSectionBtn.addEventListener("click", () => {
    ccState.modules.push({
      id: uid("mod"),
      title: `New section`,
      description: "",
      order: ccState.modules.length,
      items: [],
    });
    renderCourseContentEditor();
  });

  ccShowJsonBtn.addEventListener("click", () => {
    const show = ccJsonOutput.style.display === "none";
    ccJsonOutput.style.display = show ? "block" : "none";
    if (show) ccJsonOutput.value = JSON.stringify({ modules: ccState.modules }, null, 2);
  });

  ccCopyJsonBtn.addEventListener("click", async () => {
    const txt = JSON.stringify({ modules: ccState.modules }, null, 2);
    await navigator.clipboard.writeText(txt);
    alert("Copied JSON ‚úÖ");
  });

  ccSaveBtn.addEventListener("click", async () => {
    if (!currentContentCourseId) return alert("Open a course first.");
    try {
      await api(`/courses/${currentContentCourseId}/content`, {
        method: "PUT",
        body: JSON.stringify({ modules: ccState.modules }),
      });
      alert("Course content saved ‚úÖ");
    } catch (err) {
      alert("Save failed: " + err.message);
    }
  });
}

async function openCourseContentEditor(courseId) {
  try {
    const c = courses.find(x => x.id === courseId);
    currentContentCourseId = courseId;

    const raw = await api(`/courses/${courseId}/content`);
    const norm = normalizeCourseContent(raw);

    ccState.modules = norm.modules;
    ccCourseTitleEl.textContent = c ? c.title : `Course #${courseId}`;

    courseContentEditorEl.style.display = "block";
    setActiveSection("courses");
    renderCourseContentEditor();
    alert("Course content loaded ‚úÖ");
  } catch (err) {
    alert("Content load failed: " + err.message);
  }
}

/* =========================
   TEST QUESTIONS EDITOR (UI)
========================= */

const testContentEditorEl = document.getElementById("testContentEditor");
const tcTestTitleEl = document.getElementById("tcTestTitle");
const tcQuestionsContainer = document.getElementById("tcQuestionsContainer");
const tcAddQuestionBtn = document.getElementById("tcAddQuestionBtn");
const tcSaveBtn = document.getElementById("tcSaveBtn");

function normalizeTestQuestions(data) {
  // Accept [] or {questions:[]}
  if (Array.isArray(data)) return data;
  if (data && Array.isArray(data.questions)) return data.questions;
  return [];
}

function newQuestion() {
  return {
    id: uid("q"),
    question: "",
    options: ["", "", "", ""],
    correctIndex: 0,
    explanation: "",
    marks: 1,
    negative: 0,
  };
}

function renderTestQuestionsEditor() {
  tcQuestionsContainer.innerHTML = "";

  tcState.questions.forEach((q, qi) => {
    if (!q.id) q.id = uid("q");
    if (!Array.isArray(q.options)) q.options = ["", "", "", ""];

    const card = document.createElement("div");
    card.className = "cc-section-card";
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:700;">Q${qi + 1}</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-secondary" data-tc="q-up" data-qi="${qi}">‚Üë</button>
          <button class="btn-secondary" data-tc="q-down" data-qi="${qi}">‚Üì</button>
          <button class="btn-secondary" data-tc="q-delete" data-qi="${qi}">Delete</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <textarea
          rows="2"
          style="width:100%; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
          placeholder="Question text"
          data-tc="q-text"
          data-qi="${qi}"
        >${q.question || ""}</textarea>
      </div>

      <div style="margin-top:10px; display:grid; grid-template-columns: 1fr; gap:8px;">
        ${q.options.map((op, oi) => `
          <div style="display:flex; gap:8px; align-items:center;">
            <div style="width:22px; font-weight:700;">${String.fromCharCode(65+oi)}.</div>
            <input
              style="flex:1; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
              placeholder="Option ${oi+1}"
              value="${(op || "").replaceAll('"','&quot;')}"
              data-tc="opt"
              data-qi="${qi}"
              data-oi="${oi}"
            />
            <button class="btn-secondary" data-tc="opt-del" data-qi="${qi}" data-oi="${oi}">X</button>
          </div>
        `).join("")}

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-secondary" data-tc="opt-add" data-qi="${qi}">+ Add option</button>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <div style="min-width:220px;">
          <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">Correct option</div>
          <select
            style="width:220px; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
            data-tc="correct"
            data-qi="${qi}"
          >
            ${q.options.map((_, oi) => `<option value="${oi}" ${q.correctIndex==oi ? "selected":""}>${String.fromCharCode(65+oi)}</option>`).join("")}
          </select>
        </div>

        <div>
          <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">Marks</div>
          <input type="number" step="0.5"
            style="width:120px; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
            value="${q.marks ?? 1}"
            data-tc="marks"
            data-qi="${qi}"
          />
        </div>

        <div>
          <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">Negative</div>
          <input type="number" step="0.5"
            style="width:120px; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
            value="${q.negative ?? 0}"
            data-tc="neg"
            data-qi="${qi}"
          />
        </div>
      </div>

      <div style="margin-top:10px;">
        <textarea
          rows="2"
          style="width:100%; border-radius:8px; border:1px solid #e5e7eb; padding:7px 9px; font-size:13px;"
          placeholder="Explanation (optional)"
          data-tc="exp"
          data-qi="${qi}"
        >${q.explanation || ""}</textarea>
      </div>
    `;
    tcQuestionsContainer.appendChild(card);
  });
}

function wireTestContentEvents() {
  testContentEditorEl.addEventListener("input", (e) => {
    const t = e.target;
    if (!t.dataset || !t.dataset.tc) return;

    const key = t.dataset.tc;
    const qi = Number(t.dataset.qi);
    const oi = t.dataset.oi !== undefined ? Number(t.dataset.oi) : null;

    const q = tcState.questions[qi];
    if (!q) return;

    if (key === "q-text") q.question = t.value;
    if (key === "opt" && oi !== null) q.options[oi] = t.value;
    if (key === "exp") q.explanation = t.value;
    if (key === "marks") q.marks = Number(t.value || 0);
    if (key === "neg") q.negative = Number(t.value || 0);
  });

  testContentEditorEl.addEventListener("change", (e) => {
    const t = e.target;
    if (!t.dataset || !t.dataset.tc) return;

    const key = t.dataset.tc;
    const qi = Number(t.dataset.qi);

    const q = tcState.questions[qi];
    if (!q) return;

    if (key === "correct") q.correctIndex = Number(t.value || 0);
  });

  testContentEditorEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn || !btn.dataset || !btn.dataset.tc) return;

    const key = btn.dataset.tc;
    const qi = Number(btn.dataset.qi);
    const oi = btn.dataset.oi !== undefined ? Number(btn.dataset.oi) : null;

    if (key === "q-delete") {
      if (!confirm("Delete this question?")) return;
      tcState.questions.splice(qi, 1);
      renderTestQuestionsEditor();
      return;
    }

    if (key === "q-up" && qi > 0) {
      [tcState.questions[qi-1], tcState.questions[qi]] = [tcState.questions[qi], tcState.questions[qi-1]];
      renderTestQuestionsEditor();
      return;
    }

    if (key === "q-down" && qi < tcState.questions.length - 1) {
      [tcState.questions[qi+1], tcState.questions[qi]] = [tcState.questions[qi], tcState.questions[qi+1]];
      renderTestQuestionsEditor();
      return;
    }

    if (key === "opt-add") {
      const q = tcState.questions[qi];
      q.options.push("");
      renderTestQuestionsEditor();
      return;
    }

    if (key === "opt-del" && oi !== null) {
      const q = tcState.questions[qi];
      if (q.options.length <= 2) return alert("Minimum 2 options required.");
      q.options.splice(oi, 1);
      if (q.correctIndex >= q.options.length) q.correctIndex = 0;
      renderTestQuestionsEditor();
      return;
    }
  });

  tcAddQuestionBtn.addEventListener("click", () => {
    tcState.questions.push(newQuestion());
    renderTestQuestionsEditor();
  });

  tcSaveBtn.addEventListener("click", async () => {
    if (!currentContentTestId) return alert("Open a test first.");
    try {
      await api(`/tests/${currentContentTestId}/questions`, {
        method: "PUT",
        body: JSON.stringify(tcState.questions),
      });
      alert("Test questions saved ‚úÖ");
    } catch (err) {
      alert("Save failed: " + err.message);
    }
  });
}

async function openTestContentEditor(testId) {
  try {
    const t = tests.find(x => x.id === testId);
    currentContentTestId = testId;

    const raw = await api(`/tests/${testId}/questions`);
    tcState.questions = normalizeTestQuestions(raw);

    tcTestTitleEl.textContent = t ? t.name : `Test #${testId}`;
    testContentEditorEl.style.display = "block";

    setActiveSection("tests");
    renderTestQuestionsEditor();
    alert("Test questions loaded ‚úÖ");
  } catch (err) {
    alert("Questions load failed: " + err.message);
  }
}

/* ========= BOOTSTRAP ========= */
async function bootstrapLoad() {
  try {
    initNav();
    wireCourseContentEvents();
    wireTestContentEvents();

    await renderCourses();
    await renderTests();
    await renderUpdates();
    renderStats();
    setActiveSection("overview");
  } catch (err) {
    alert("Bootstrap failed: " + err.message + "\n\n(backend running? API_BASE correct?)");
    console.error(err);
  }
}

/* ========= AUTH ========= */
auth.onAuthStateChanged((user) => {
  if (!user || !ALLOWED_ADMINS.includes(user.email)) {
    if (user) auth.signOut();
    window.location.href = "index.html";
    return;
  }

  adminEmailEl.textContent = user.email;
  avatarInitialEl.textContent = (user.email || "A").slice(0, 1).toUpperCase();

  overlay.style.display = "none";
  bootstrapLoad();
});

logoutBtn.onclick = async () => {
  await auth.signOut();
  window.location.href = "index.html";
};
</script>
</body>
</html>

